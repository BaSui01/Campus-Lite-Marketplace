name: Backend E2E Nightly

on:
  schedule:
    - cron: "0 20 * * *" # 每日凌晨（UTC 20:00 ≈ 北京时间 04:00）
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      SPRING_PROFILES_ACTIVE: e2e
      DB_HOST: 127.0.0.1
      DB_PORT: 5432
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      DB_NAME: campus_marketplace_dev
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: campus_marketplace_dev
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Build backend (skip tests)
        run: mvn -f backend/pom.xml -DskipTests -DskipITs=true clean package

      - name: Install Newman
        run: |
          npm install -g newman

      - name: Launch backend (e2e profile)
        run: |
          nohup mvn -f backend/pom.xml spring-boot:run -Dspring-boot.run.profiles=${SPRING_PROFILES_ACTIVE} > backend-e2e.log 2>&1 &
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8080/actuator/health > /dev/null; then
              echo "Backend is up";
              break;
            fi;
            echo "Waiting backend startup ($i/30)...";
            sleep 5;
          done
          curl -sf http://127.0.0.1:8080/actuator/health

      - name: Run Postman E2E collection
        run: |
          chmod +x backend/tests/e2e/run-e2e.sh
          bash backend/tests/e2e/run-e2e.sh

      - name: Upload Newman report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-newman-report
          path: backend/tests/e2e/report/e2e-results.xml

      - name: Upload backend log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-e2e-log
          path: backend-e2e.log

      - name: Shutdown backend
        if: always()
        run: |
          pkill -f "spring-boot:run" || true
