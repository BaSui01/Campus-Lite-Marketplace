name: Backend Quality Gates

on:
  push:
    paths:
      - 'backend/**'
      - '.github/workflows/backend-quality-gates.yml'
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/backend-quality-gates.yml'

concurrency:
  group: backend-quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: campus_marketplace_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping || exit 1" --health-interval=10s --health-timeout=5s --health-retries=5
    env:
      MAVEN_OPTS: -Xmx2g
      RUN_API_E2E: 'true'
      RUN_JMETER: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Unit tests (Surefire)
        run: |
          mvn -B -f backend/pom.xml -DskipITs=true test

      - name: Integration tests + Coverage (Failsafe + JaCoCo)
        run: |
          mvn -B -f backend/pom.xml verify

      - name: Dependency-Check (OWASP)
        run: |
          mvn -B -f backend/pom.xml org.owasp:dependency-check-maven:check -Dformat=HTML -DfailBuildOnCVSS=7
        continue-on-error: false

      - name: Upload Dependency-Check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: backend/target/dependency-check-report.html
          if-no-files-found: warn

      - name: Mutation Testing (PIT)
        run: |
          mvn -B -f backend/pom.xml org.pitest:pitest-maven:mutationCoverage
        continue-on-error: false

      - name: Upload PIT report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-report
          path: backend/target/pit-reports/**
          if-no-files-found: warn

      # Optional API E2E via Newman (requires running app). Disabled by default.
      - name: Setup Node for Newman
        if: env.RUN_API_E2E == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        if: env.RUN_API_E2E == 'true'
        run: npm i -g newman

      - name: Start backend (profile: test-ci)
        if: env.RUN_API_E2E == 'true'
        run: |
          nohup bash -lc 'CI_DB_HOST=127.0.0.1 CI_DB_PORT=5432 CI_DB_NAME=campus_marketplace_test CI_DB_USERNAME=postgres CI_DB_PASSWORD=postgres \
            CI_REDIS_HOST=127.0.0.1 CI_REDIS_PORT=6379 \
            mvn -f backend/pom.xml -DskipTests spring-boot:run -Dspring-boot.run.profiles=test-ci' >/tmp/app.log 2>&1 &
          for i in {1..30}; do echo "Waiting for app... $i"; sleep 2; if curl -s http://localhost:8080/actuator/health | grep -q 'UP'; then echo "App is up"; break; fi; done
          curl -s http://localhost:8080/actuator/health || (echo "App failed to start" && tail -n 200 /tmp/app.log && exit 1)

      - name: Run Newman collection (requires app running)
        if: env.RUN_API_E2E == 'true'
        run: |
          newman run backend/tests/postman/backend-smoke.postman_collection.json \
            -e backend/tests/postman/backend-local.postman_environment.json

      - name: Run JMeter smoke
        if: env.RUN_JMETER == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y jmeter
          jmeter -n -t backend/tests/jmeter/search_smoke.jmx -l backend/target/jmeter-results.jtl

      # Optional JMeter smoke (requires app running and JMeter installation).
      - name: Stop backend
        if: always()
        run: |
          pkill -f 'spring-boot:run' || true

      - name: Upload JMeter results
        if: env.RUN_JMETER == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: backend/target/jmeter-results.jtl
          if-no-files-found: warn
