# ğŸ”’ æ¯å‘¨å®‰å…¨æ‰«æå·¥ä½œæµ
# ä½œç”¨ï¼šå®šæœŸæ£€æŸ¥ä¾èµ–å®‰å…¨æ¼æ´ï¼ŒåŠæ—¶å‘ç°å¹¶ä¿®å¤é«˜å±é£é™©
# æ‰§è¡Œï¼šæ¯å‘¨ä¸€å‡Œæ™¨ 2:00ï¼ˆUTCï¼‰è‡ªåŠ¨è¿è¡Œï¼Œä¹Ÿå¯æ‰‹åŠ¨è§¦å‘

name: Security Weekly Scan

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å‘¨ä¸€å‡Œæ™¨ 2:00 UTCï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '0 2 * * 1'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      cvss_threshold:
        description: 'CVSS é˜ˆå€¼ï¼ˆå¤±è´¥æ„å»ºï¼‰'
        required: false
        default: '7'
        type: choice
        options:
          - '7'
          - '8'
          - '9'
      upload_sarif:
        description: 'æ˜¯å¦ä¸Šä¼  SARIF åˆ° GitHub Security'
        required: false
        default: 'true'
        type: boolean

concurrency:
  group: security-scan-${{ github.ref }}
  cancel-in-progress: false  # å®‰å…¨æ‰«æä¸ä¸­æ–­ï¼Œç¡®ä¿å®Œæ•´æ‰§è¡Œ

permissions:
  contents: read
  security-events: write  # å…è®¸ä¸Šä¼  SARIF åˆ° GitHub Security

jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: â˜• è®¾ç½® Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: ğŸ“¦ ä¸‹è½½å¹¶ç¼“å­˜ NVD æ•°æ®åº“ï¼ˆåŠ é€Ÿæ‰«æï¼‰
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: nvd-data-${{ github.run_id }}
          restore-keys: |
            nvd-data-

      - name: ğŸ” è¿è¡Œ OWASP Dependency-Checkï¼ˆHTML æ ¼å¼ï¼‰
        run: |
          mvn -B -f backend/pom.xml \
            org.owasp:dependency-check-maven:check \
            -Dformat=HTML \
            -DfailBuildOnCVSS=${{ inputs.cvss_threshold || '7' }} \
            -DsuppressionFile=backend/.owasp/suppressions.xml
        continue-on-error: true  # å…è®¸å¤±è´¥ï¼Œç¨åé€šè¿‡ Issue å‘Šè­¦

      - name: ğŸ“Š ç”Ÿæˆ SARIF æŠ¥å‘Šï¼ˆç”¨äº GitHub Securityï¼‰
        if: ${{ inputs.upload_sarif == 'true' || inputs.upload_sarif == '' }}
        run: |
          mvn -B -f backend/pom.xml \
            org.owasp:dependency-check-maven:check \
            -Dformat=SARIF \
            -DfailBuildOnCVSS=10  # SARIF ç”Ÿæˆä¸å¤±è´¥
        continue-on-error: true

      - name: ğŸ” ä¸Šä¼  SARIF åˆ° GitHub Security
        if: ${{ inputs.upload_sarif == 'true' || inputs.upload_sarif == '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: backend/target/dependency-check-report.sarif
          category: dependency-check
        continue-on-error: true  # é¿å…å›  GitHub Security æœåŠ¡é—®é¢˜å¯¼è‡´å¤±è´¥

      - name: ğŸ“„ ä¸Šä¼  HTML æŠ¥å‘Šåˆ° Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-${{ github.run_number }}
          path: backend/target/dependency-check-report.html
          retention-days: 90  # ä¿ç•™ 90 å¤©
          if-no-files-found: warn

      - name: ğŸ“‹ è§£ææ‰«æç»“æœå¹¶æå–é«˜å±æ¼æ´
        if: always()
        id: parse_results
        run: |
          # æ£€æŸ¥ HTML æŠ¥å‘Šæ˜¯å¦å­˜åœ¨é«˜å±æ¼æ´
          if [ -f backend/target/dependency-check-report.html ]; then
            # æå– CVSS >= 7 çš„æ¼æ´æ•°é‡
            HIGH_VULN_COUNT=$(grep -o 'CVSS Score: [7-9]\.[0-9]' backend/target/dependency-check-report.html | wc -l || echo "0")
            CRITICAL_VULN_COUNT=$(grep -o 'CVSS Score: [9-9]\.[0-9]' backend/target/dependency-check-report.html | wc -l || echo "0")

            echo "high_count=$HIGH_VULN_COUNT" >> $GITHUB_OUTPUT
            echo "critical_count=$CRITICAL_VULN_COUNT" >> $GITHUB_OUTPUT

            if [ "$HIGH_VULN_COUNT" -gt 0 ]; then
              echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            else
              echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            fi

            echo "ğŸ“Š æ‰«æç»“æœï¼š"
            echo "  - é«˜å±æ¼æ´ï¼ˆCVSS 7-8.9ï¼‰: $HIGH_VULN_COUNT"
            echo "  - ä¸¥é‡æ¼æ´ï¼ˆCVSS 9-10ï¼‰: $CRITICAL_VULN_COUNT"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ‰«ææŠ¥å‘Š"
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš¨ åˆ›å»º GitHub Issueï¼ˆå‘ç°é«˜å±æ¼æ´æ—¶ï¼‰
        if: steps.parse_results.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const high = '${{ steps.parse_results.outputs.high_count }}';
            const critical = '${{ steps.parse_results.outputs.critical_count }}';
            const runNumber = '${{ github.run_number }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const issueTitle = `ğŸ”’ å®‰å…¨å‘Šè­¦ï¼šå‘ç° ${high} ä¸ªé«˜å±ä¾èµ–æ¼æ´ (Week ${new Date().toISOString().slice(0, 10)})`;
            const issueBody = `
            ## ğŸš¨ å®‰å…¨æ‰«æå‘Šè­¦

            **æ‰«ææ—¶é—´**: ${new Date().toISOString()}
            **æ‰«æç¼–å·**: #${runNumber}
            **æ‰«ææŠ¥å‘Š**: [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${runUrl})

            ---

            ### ğŸ“Š æ¼æ´ç»Ÿè®¡

            | ä¸¥é‡ç¨‹åº¦ | æ•°é‡ |
            |---------|------|
            | ğŸ”´ ä¸¥é‡ï¼ˆCVSS 9-10ï¼‰ | **${critical}** |
            | ğŸŸ  é«˜å±ï¼ˆCVSS 7-8.9ï¼‰ | **${high}** |

            ---

            ### ğŸ”§ å¤„ç†å»ºè®®

            1. **ç«‹å³æŸ¥çœ‹æŠ¥å‘Š**ï¼šä¸‹è½½ [dependency-check-report-${runNumber}](${runUrl}) Artifacts
            2. **åˆ†æå½±å“èŒƒå›´**ï¼šç¡®è®¤æ¼æ´æ˜¯å¦å½±å“ç”Ÿäº§ç¯å¢ƒ
            3. **å‡çº§ä¾èµ–**ï¼šå‚è€ƒ \`docs/quality-assurance-plan.md\` å®‰å…¨æ•´æ”¹è®¡åˆ’
            4. **éªŒè¯å…¼å®¹æ€§**ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ \`mvn verify\`
            5. **æ›´æ–°æ–‡æ¡£**ï¼šå‡çº§å®Œæˆåæ›´æ–°å®‰å…¨æ•´æ”¹è®¡åˆ’

            ---

            ### ğŸ“ ç›¸å…³æ–‡æ¡£

            - [è´¨é‡ä¿éšœè®¡åˆ’](../blob/main/docs/quality-assurance-plan.md)
            - [OWASP Dependency-Check å®˜æ–¹æ–‡æ¡£](https://jeremylong.github.io/DependencyCheck/)
            - [Maven ä¾èµ–ç®¡ç†æœ€ä½³å®è·µ](../blob/main/backend/pom.xml)

            ---

            **è‡ªåŠ¨åˆ›å»ºäº**: \`security-weekly-scan\` å·¥ä½œæµ
            `;

            // æœç´¢æ˜¯å¦å·²æœ‰æœªå…³é—­çš„å®‰å…¨å‘Šè­¦ Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies',
              per_page: 10
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('å®‰å…¨å‘Šè­¦') &&
              issue.title.includes(new Date().toISOString().slice(0, 10))
            );

            if (existingIssue) {
              // æ›´æ–°ç°æœ‰ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ **æ‰«æç»“æœæ›´æ–°** (#${runNumber})\n\n${issueBody}`
              });
              console.log(`âœ… å·²æ›´æ–°ç°æœ‰ Issue: #${existingIssue.number}`);
            } else {
              // åˆ›å»ºæ–° Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'dependencies', 'high-priority']
              });
              console.log(`âœ… å·²åˆ›å»ºæ–° Issue`);
            }

      - name: âœ… æ‰«æå®Œæˆé€šçŸ¥
        if: always()
        run: |
          if [ "${{ steps.parse_results.outputs.has_vulnerabilities }}" == "true" ]; then
            echo "âš ï¸ å‘ç° ${{ steps.parse_results.outputs.high_count }} ä¸ªé«˜å±æ¼æ´ï¼"
            echo "ğŸš¨ å·²è‡ªåŠ¨åˆ›å»º GitHub Issueï¼Œè¯·åŠæ—¶å¤„ç†ï¼"
            exit 1  # å¤±è´¥é€€å‡º
          else
            echo "âœ… æœªå‘ç°é«˜å±æ¼æ´ï¼Œä¾èµ–å®‰å…¨ï¼"
          fi
