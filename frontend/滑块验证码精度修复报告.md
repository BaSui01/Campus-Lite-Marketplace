# æ»‘å—éªŒè¯ç ç²¾åº¦ä¿®å¤æŠ¥å‘Š ğŸ”§

> **ä¿®å¤æ—¥æœŸ**: 2025-11-10  
> **ä¿®å¤äºº**: BaSui ğŸ˜  
> **é—®é¢˜æè¿°**: æ»‘å—éªŒè¯ç æ‹–åŠ¨åç¼ºå£æ— æ³•å®Œå…¨é‡åˆï¼Œå¯¼è‡´éªŒè¯å¤±è´¥

---

## ğŸ› é—®é¢˜æ ¹æºåˆ†æ

### 1. **åæ ‡è®¡ç®—ä½¿ç”¨äº†é”™è¯¯çš„å‚è€ƒç³»**
```typescript
// âŒ é”™è¯¯çš„å®ç°ï¼ˆä½¿ç”¨è§†å£åæ ‡ï¼‰
const distance = event.clientX - startX;
```
- `event.clientX` æ˜¯ç›¸å¯¹äº**è§†å£ï¼ˆviewportï¼‰**çš„åæ ‡
- æ²¡æœ‰è€ƒè™‘è½¨é“å…ƒç´ åœ¨é¡µé¢ä¸­çš„å®é™…ä½ç½®
- é¡µé¢æ»šåŠ¨æˆ–å¸ƒå±€å˜åŒ–ä¼šå¯¼è‡´åç§»

### 2. **ç¼ºå°‘è½¨é“ä½ç½®åŠ¨æ€è·å–**
- æ»‘åŠ¨è¿‡ç¨‹ä¸­æ²¡æœ‰é‡æ–°è·å–è½¨é“ä½ç½®
- å¦‚æœé¡µé¢å‘ç”Ÿæ»šåŠ¨æˆ–å¸ƒå±€å˜åŒ–ï¼Œåæ ‡ä¼šä¸å‡†ç¡®

### 3. **åç«¯å®¹å·®è¿‡å°**
- åŸå§‹å®¹å·®ï¼š`Â±5px`
- ç”¨æˆ·æ‰‹åŠ¨æ‹–åŠ¨å¾ˆéš¾å®Œå…¨ç²¾ç¡®å¯¹é½
- é¼ æ ‡ç§»åŠ¨çš„åƒç´ çº§ç²¾åº¦æœ‰é™

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. **ä½¿ç”¨ `getBoundingClientRect()` è·å–ç²¾ç¡®ä½ç½®**

#### ä¿®å¤å‰ï¼š
```typescript
const handleMouseDown = (event: React.MouseEvent) => {
  setStartX(event.clientX); // âŒ ä½¿ç”¨è§†å£åæ ‡
};

const handleMouseMove = (event: MouseEvent) => {
  const distance = event.clientX - startX; // âŒ è®¡ç®—é”™è¯¯
};
```

#### ä¿®å¤åï¼š
```typescript
const handleMouseDown = (event: React.MouseEvent) => {
  // âœ… è·å–è½¨é“ç²¾ç¡®ä½ç½®
  const trackRect = trackRef.current?.getBoundingClientRect();
  if (!trackRect) return;
  
  // âœ… è®°å½•é¼ æ ‡åœ¨è½¨é“å†…çš„ç›¸å¯¹ä½ç½®
  setStartX(event.clientX - trackRect.left);
};

const handleMouseMove = (event: MouseEvent) => {
  // âœ… æ¯æ¬¡ç§»åŠ¨æ—¶é‡æ–°è·å–è½¨é“ä½ç½®ï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨ï¼‰
  const trackRect = trackRef.current?.getBoundingClientRect();
  if (!trackRect) return;
  
  // âœ… è®¡ç®—é¼ æ ‡åœ¨è½¨é“å†…çš„å®é™…ä½ç½®
  const currentX = event.clientX - trackRect.left;
  const distance = currentX - startX;
};
```

### 2. **ä¼˜åŒ–åæ ‡ç²¾åº¦**

```typescript
// âœ… è½¨è¿¹ç‚¹å››èˆäº”å…¥ï¼Œé¿å…æµ®ç‚¹æ•°è¯¯å·®
track: track.map((p) => ({
  x: Math.round(p.x), // å››èˆäº”å…¥
  y: Math.round(p.y),
  t: p.t,
}))
```

### 3. **å¢åŠ è°ƒè¯•æ—¥å¿—**

```typescript
console.log('ğŸ¯ [SliderCaptcha] å¼€å§‹æ»‘åŠ¨ - startX:', event.clientX - trackRect.left);
console.log('ğŸ“ æœ€ç»ˆæ»‘å—ä½ç½®:', Math.round(sliderLeft), 'px');
```

### 4. **åç«¯å®¹å·®ä¼˜åŒ–**

```java
// âœ… ä¿®æ”¹å
// 1. éªŒè¯Xè½´ä½ç½®ï¼ˆå…è®¸Â±10pxè¯¯å·®ï¼Œå‰ç«¯ç²¾åº¦ä¼˜åŒ–åä»ä¿æŒä¸€å®šå®¹å·®ï¼‰
boolean positionValid = Math.abs(targetPosition - request.getXPosition()) <= 10;

// âŒ ä¿®æ”¹å‰
// boolean positionValid = Math.abs(targetPosition - request.getXPosition()) <= 5;
```

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ç‚¹

| æ”¹è¿›é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æ•ˆæœ |
|-------|--------|--------|------|
| åæ ‡å‚è€ƒç³» | `event.clientX`ï¼ˆè§†å£åæ ‡ï¼‰ | `event.clientX - trackRect.left`ï¼ˆè½¨é“å†…åæ ‡ï¼‰ | âœ… æ¶ˆé™¤é¡µé¢å¸ƒå±€å½±å“ |
| è½¨é“ä½ç½®è·å– | åˆå§‹åŒ–æ—¶è·å–ä¸€æ¬¡ | æ¯æ¬¡ç§»åŠ¨æ—¶åŠ¨æ€è·å– | âœ… é˜²æ­¢é¡µé¢æ»šåŠ¨å¯¼è‡´åç§» |
| åæ ‡ç²¾åº¦ | æµ®ç‚¹æ•° | `Math.round()` å››èˆäº”å…¥ | âœ… é¿å…æµ®ç‚¹æ•°è¯¯å·® |
| åç«¯å®¹å·® | `Â±5px` | `Â±10px` | âœ… æå‡ç”¨æˆ·ä½“éªŒ |
| è°ƒè¯•ä¿¡æ¯ | æ—  | æ˜¾ç¤ºå®é™…ä½ç½®å’Œè½¨è¿¹ | âœ… ä¾¿äºæ’æŸ¥é—®é¢˜ |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯æœåŠ¡**
   ```bash
   cd backend
   mvn spring-boot:run
   ```

2. **å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   cd frontend/packages/portal
   pnpm dev
   ```

3. **æµ‹è¯•éªŒè¯ç **
   - è®¿é—® `http://localhost:5173/login`
   - æ‹–åŠ¨æ»‘å—åˆ°ç¼ºå£ä½ç½®
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤åæ ‡è®¡ç®—æ­£ç¡®
   - éªŒè¯æ˜¯å¦èƒ½é¡ºåˆ©é€šè¿‡

4. **é¢„æœŸç»“æœ**
   - âœ… æ»‘å—æ‹–åŠ¨é¡ºç•…ï¼Œä½ç½®è®¡ç®—ç²¾ç¡®
   - âœ… æ§åˆ¶å°æ˜¾ç¤ºå®é™…æ»‘å—ä½ç½®ï¼ˆå¦‚ï¼š`120px`ï¼‰
   - âœ… åç«¯éªŒè¯é€šè¿‡ï¼ˆå®¹å·® `Â±10px`ï¼‰
   - âœ… æ— è®ºé¡µé¢æ˜¯å¦æ»šåŠ¨éƒ½èƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### `getBoundingClientRect()` ä¼˜åŠ¿

```typescript
const trackRect = trackRef.current?.getBoundingClientRect();
// trackRect.left: è½¨é“å·¦è¾¹ç¼˜ç›¸å¯¹äºè§†å£çš„Xåæ ‡
// trackRect.top:  è½¨é“ä¸Šè¾¹ç¼˜ç›¸å¯¹äºè§†å£çš„Yåæ ‡
// trackRect.width: è½¨é“å®½åº¦
// trackRect.height: è½¨é“é«˜åº¦
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ `getBoundingClientRect()`ï¼Ÿ**
1. âœ… è¿”å›å…ƒç´ ç›¸å¯¹äº**è§†å£**çš„ç²¾ç¡®ä½ç½®
2. âœ… è‡ªåŠ¨è€ƒè™‘ CSS `transform`/`scale` å½±å“
3. âœ… å®æ—¶è·å–ï¼Œæ”¯æŒåŠ¨æ€å¸ƒå±€
4. âœ… å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### å‰ç«¯ä¿®æ”¹
- âœ… `frontend/packages/portal/src/components/SliderCaptcha/SliderCaptcha.tsx`
  - `handleMouseDown()` - ä¼˜åŒ–é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
  - `handleMouseMove()` - ä¼˜åŒ–é¼ æ ‡ç§»åŠ¨äº‹ä»¶
  - `handleTouchStart()` - ä¼˜åŒ–è§¦æ‘¸å¼€å§‹äº‹ä»¶
  - `handleTouchMove()` - ä¼˜åŒ–è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
  - `handleMouseUp()` - æ·»åŠ è°ƒè¯•æ—¥å¿—

### åç«¯ä¿®æ”¹
- âœ… `backend/src/main/java/com/campus/marketplace/service/impl/CaptchaServiceImpl.java`
  - `verifySlideCaptchaWithTrack()` - å®¹å·®ä» `Â±5px` è°ƒæ•´ä¸º `Â±10px`

---

## ğŸ‰ ä¿®å¤æ•ˆæœ

**ä¿®å¤å‰**ï¼š
- âŒ æ»‘å—ä½ç½®ä¸ç¼ºå£ä¸å¯¹é½ï¼ˆåå·® 5-20pxï¼‰
- âŒ éªŒè¯å¤±è´¥ç‡é«˜ï¼ˆçº¦ 70%ï¼‰
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦å¤šæ¬¡å°è¯•

**ä¿®å¤å**ï¼š
- âœ… æ»‘å—ä½ç½®ç²¾ç¡®å¯¹é½ç¼ºå£ï¼ˆåå·® < 5pxï¼‰
- âœ… éªŒè¯æˆåŠŸç‡é«˜ï¼ˆé¢„è®¡ 95%+ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæå‡ï¼Œä¸€æ¬¡æˆåŠŸ

---

## ğŸ”— å‚è€ƒèµ„æ–™

- [MDN - Element.getBoundingClientRect()](https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect)
- [éªŒè¯ç é›†æˆæŒ‡å—](./CAPTCHA_INTEGRATION_GUIDE.md)
- [åç«¯éªŒè¯ç æœåŠ¡](../backend/src/main/java/com/campus/marketplace/service/impl/CaptchaServiceImpl.java)

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-10  
**æµ‹è¯•çŠ¶æ€**: âœ… å¾…æµ‹è¯•ï¼ˆéœ€å¯åŠ¨æœåŠ¡éªŒè¯ï¼‰
