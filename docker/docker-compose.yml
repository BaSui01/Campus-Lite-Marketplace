# ==========================================================
# æ ¡å›­è½»äº«é›†å¸‚ç³»ç»Ÿ - Docker Compose é…ç½®æ–‡ä»¶
# ==========================================================
# ğŸ“ ä½œè€…: BaSui ğŸ˜
# ğŸ“… æ›´æ–°: 2025-10-25
# ğŸ¯ ç”¨é€”: ä¸€é”®å¯åŠ¨å®Œæ•´çš„åº”ç”¨æ ˆ
#
# ğŸš€ å¿«é€Ÿå¯åŠ¨:
#   1. åŸºç¡€æœåŠ¡ï¼ˆæ¨èï¼‰:
#      docker compose --project-directory . -f docker/docker-compose.yml up -d
#
#   2. åŒ…å«å¼€å‘å·¥å…·ï¼ˆMailHogï¼‰:
#      docker compose --project-directory . -f docker/docker-compose.yml --profile devtools up -d
#
#   3. åŒ…å«ç›‘æ§å¥—ä»¶ï¼ˆPrometheus + Grafanaï¼‰:
#      docker compose --project-directory . -f docker/docker-compose.yml --profile observability up -d
#
#   4. å®Œæ•´å¯åŠ¨ï¼ˆæ‰€æœ‰æœåŠ¡ï¼‰:
#      docker compose --project-directory . -f docker/docker-compose.yml --profile devtools --profile observability up -d
#
# ğŸ“¦ é»˜è®¤å¯åŠ¨çš„æœåŠ¡:
#   - PostgreSQL 16ï¼ˆä¸»æ•°æ®åº“ï¼‰
#   - Redis 7.4ï¼ˆç¼“å­˜ + ä¼šè¯ï¼‰
#
# ğŸ”§ å¯é€‰æœåŠ¡ï¼ˆé€šè¿‡ profiles å¯ç”¨æˆ–å–æ¶ˆæ³¨é‡Šï¼‰:
#   - Backendï¼ˆSpring Boot åç«¯ï¼‰â†’ å–æ¶ˆæ³¨é‡Šç›¸å…³é…ç½®ï¼ˆæ¨èæœ¬åœ°è¿è¡Œï¼‰
#   - Nginxï¼ˆåå‘ä»£ç†ï¼‰â†’ å–æ¶ˆæ³¨é‡Šç›¸å…³é…ç½®ï¼ˆç”Ÿäº§éƒ¨ç½²æ—¶éœ€è¦ï¼‰
#   - MailHogï¼ˆé‚®ä»¶æµ‹è¯•å·¥å…·ï¼‰â†’ --profile devtools
#   - Prometheus + Grafanaï¼ˆç›‘æ§ï¼‰â†’ --profile observability
#   - PostgreSQL Replicaï¼ˆè¯»å†™åˆ†ç¦»ï¼‰â†’ å–æ¶ˆæ³¨é‡Šç›¸å…³é…ç½®
#   - Redis Sentinelï¼ˆé«˜å¯ç”¨ï¼‰â†’ å–æ¶ˆæ³¨é‡Šç›¸å…³é…ç½®
#
# ğŸ“– ç¯å¢ƒå˜é‡è¯´æ˜:
#   - ç¯å¢ƒå˜é‡ä»é¡¹ç›®æ ¹ç›®å½•çš„ .env æ–‡ä»¶è¯»å–
#   - è¯­æ³•: ${å˜é‡å:-é»˜è®¤å€¼} â†’ å¦‚æœæœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼
#   - è¯­æ³•: ${å˜é‡å:?é”™è¯¯ä¿¡æ¯} â†’ å¿…é¡»è®¾ç½®ï¼Œå¦åˆ™æŠ¥é”™
# ==========================================================

# ==========================================================
# ğŸ¨ å¯å¤ç”¨é…ç½®å—ï¼ˆYAML Anchorsï¼‰
# ==========================================================
# ğŸ“ è¯´æ˜: ä½¿ç”¨ &backend-env å®šä¹‰å¯å¤ç”¨çš„ç¯å¢ƒå˜é‡å—
#         åœ¨ backend æœåŠ¡ä¸­é€šè¿‡ <<: *backend-env å¼•ç”¨
# ğŸ’¡ å¥½å¤„: é¿å…é‡å¤ï¼Œç»Ÿä¸€ç®¡ç†åç«¯ç¯å¢ƒå˜é‡
# ==========================================================
x-backend-env: &backend-env
  # Spring Boot è¿è¡Œç¯å¢ƒ
  # å¯é€‰å€¼: devï¼ˆå¼€å‘ï¼‰ã€testï¼ˆæµ‹è¯•ï¼‰ã€prodï¼ˆç”Ÿäº§ï¼‰
  SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}

  # æ•°æ®åº“è¿æ¥é…ç½®
  DB_HOST: ${DB_HOST:-postgres}              # æ•°æ®åº“ä¸»æœºåï¼ˆé»˜è®¤: postgres æœåŠ¡åï¼‰
  DB_PORT: ${DB_PORT:-5432}                  # æ•°æ®åº“ç«¯å£ï¼ˆPostgreSQL é»˜è®¤ 5432ï¼‰
  DB_NAME: ${DB_NAME:-campus_marketplace}    # æ•°æ®åº“åç§°
  DB_USERNAME: ${DB_USERNAME:-postgres}      # æ•°æ®åº“ç”¨æˆ·å
  DB_PASSWORD: ${DB_PASSWORD:-123456}        # æ•°æ®åº“å¯†ç ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹ï¼ï¼‰

  # Redis è¿æ¥é…ç½®
  REDIS_HOST: ${REDIS_HOST:-redis}           # Redis ä¸»æœºåï¼ˆé»˜è®¤: redis æœåŠ¡åï¼‰
  REDIS_PORT: ${REDIS_PORT:-6379}            # Redis ç«¯å£ï¼ˆé»˜è®¤ 6379ï¼‰
  REDIS_PASSWORD: ${REDIS_PASSWORD:-}        # Redis å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºæ— å¯†ç ï¼‰

  # Redis Sentinel é«˜å¯ç”¨é…ç½®ï¼ˆå¯é€‰ï¼‰
  REDIS_SENTINEL_MASTER: ${REDIS_SENTINEL_MASTER:-}  # Sentinel ä¸»èŠ‚ç‚¹åç§°ï¼ˆç•™ç©ºåˆ™ä¸å¯ç”¨ï¼‰
  REDIS_SENTINEL_NODES: ${REDIS_SENTINEL_NODES:-}    # Sentinel èŠ‚ç‚¹åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚: sentinel1:26379,sentinel2:26379ï¼‰

  # JWT å¯†é’¥é…ç½®
  # âš ï¸ å¿…é¡»è®¾ç½®ï¼æœªè®¾ç½®ä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥
  # ğŸ” ç”Ÿæˆæ–¹å¼: python -c "import secrets; print(secrets.token_urlsafe(64))"
  JWT_SECRET: ${JWT_SECRET:?è¯·åœ¨ .env ä¸­è®¾ç½® JWT_SECRET}

# ==========================================================
# ğŸ³ æœåŠ¡å®šä¹‰
# ==========================================================
services:
  # ========================================
  # ğŸ“Š PostgreSQL 16ï¼ˆä¸»æ•°æ®åº“ï¼‰
  # ========================================
  postgres:
    # Docker é•œåƒ
    # å¯é€‰ç‰ˆæœ¬: postgres:16, postgres:15, postgres:14
    image: postgres:16

    # å®¹å™¨åç§°ï¼ˆæ–¹ä¾¿æŸ¥çœ‹å’Œç®¡ç†ï¼‰
    container_name: campus-postgres

    # é‡å¯ç­–ç•¥
    # å¯é€‰å€¼:
    #   - no: ä¸è‡ªåŠ¨é‡å¯
    #   - always: æ€»æ˜¯é‡å¯
    #   - on-failure: å¤±è´¥æ—¶é‡å¯
    #   - unless-stopped: é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™æ€»æ˜¯é‡å¯ï¼ˆæ¨èï¼‰
    restart: unless-stopped

    # ç¯å¢ƒå˜é‡
    environment:
      POSTGRES_DB: ${DB_NAME:-campus_marketplace}     # åˆå§‹åŒ–æ—¶åˆ›å»ºçš„æ•°æ®åº“å
      POSTGRES_USER: ${DB_USERNAME:-postgres}         # æ•°æ®åº“è¶…çº§ç”¨æˆ·å
      POSTGRES_PASSWORD: ${DB_PASSWORD:-123456}       # æ•°æ®åº“è¶…çº§ç”¨æˆ·å¯†ç 
      POSTGRES_INITDB_ARGS: "-E UTF8"                 # åˆå§‹åŒ–å‚æ•°ï¼ˆUTF8 ç¼–ç ï¼‰

    # æ•°æ®å·æŒ‚è½½
    # ğŸ’¾ æŒä¹…åŒ–æ•°æ®åˆ° Docker Volumeï¼Œé¿å…å®¹å™¨åˆ é™¤åæ•°æ®ä¸¢å¤±
    volumes:
      - postgres_data:/var/lib/postgresql/data             # æ•°æ®åº“æ–‡ä»¶å­˜å‚¨
      # - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro  # ğŸ“ å¯é€‰: åˆå§‹åŒ– SQL è„šæœ¬ï¼ˆFlyway å·²è´Ÿè´£è¿ç§»ï¼Œé€šå¸¸ä¸éœ€è¦ï¼‰

    # ç«¯å£æ˜ å°„
    # æ ¼å¼: "ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£"
    # ğŸ’¡ å¯ä»¥æ”¹æˆ "5433:5432" é¿å…ä¸æœ¬åœ° PostgreSQL å†²çª
    ports:
      - "${DB_PORT:-5432}:5432"

    # å¥åº·æ£€æŸ¥
    # ğŸ¥ ç”¨äºç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨åå†å¯åŠ¨ä¾èµ–å®ƒçš„æœåŠ¡
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres}"]  # æ£€æŸ¥å‘½ä»¤
      interval: 10s        # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
      timeout: 5s          # è¶…æ—¶æ—¶é—´ 5 ç§’
      retries: 5           # å¤±è´¥ 5 æ¬¡åæ ‡è®°ä¸º unhealthy

    # ç½‘ç»œé…ç½®
    # ğŸ“¡ åŠ å…¥ campus ç½‘ç»œï¼Œä¸å…¶ä»–æœåŠ¡äº’è”
    networks:
      - campus

  # ========================================
  # ğŸ”´ Redis 7.4ï¼ˆç¼“å­˜ + ä¼šè¯å­˜å‚¨ï¼‰
  # ========================================
  redis:
    # Docker é•œåƒ
    # å¯é€‰ç‰ˆæœ¬: redis:7.4, redis:7.2, redis:7.0, redis:6.2
    image: redis:7.4

    # å®¹å™¨åç§°
    container_name: campus-redis

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # å¯åŠ¨å‘½ä»¤
    # ğŸ’¡ æ ¹æ®æ˜¯å¦è®¾ç½®å¯†ç æ¥å†³å®šå¯åŠ¨å‚æ•°
    # ğŸ“ å‚æ•°è¯´æ˜:
    #   - appendonly yes: å¯ç”¨ AOF æŒä¹…åŒ–
    #   - maxmemory 512mb: æœ€å¤§å†…å­˜ 512MBï¼ˆå¯æ”¹æˆ 1gb, 2gb ç­‰ï¼‰
    #   - maxmemory-policy allkeys-lru: å†…å­˜æ»¡æ—¶æ·˜æ±°æœ€å°‘ä½¿ç”¨çš„é”®
    #     å…¶ä»–ç­–ç•¥: allkeys-lfuï¼ˆæœ€å°‘é¢‘ç‡ï¼‰ã€volatile-lruï¼ˆä»…æ·˜æ±°è¿‡æœŸé”®ï¼‰
    #   - requirepass: è®¾ç½®å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰
    command: >
      sh -c "if [ -z \"${REDIS_PASSWORD}\" ]; then
        exec redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru;
      else
        exec redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru;
      fi"

    # æ•°æ®å·æŒ‚è½½
    volumes:
      - redis_data:/data   # Redis æ•°æ®æŒä¹…åŒ–

    # ç«¯å£æ˜ å°„
    # ğŸ’¡ å¯ä»¥æ”¹æˆ "6380:6379" é¿å…ä¸æœ¬åœ° Redis å†²çª
    ports:
      - "${REDIS_PORT:-6379}:6379"

    # å¥åº·æ£€æŸ¥
    # ğŸ¥ æ ¹æ®æ˜¯å¦è®¾ç½®å¯†ç æ¥å†³å®šæ£€æŸ¥å‘½ä»¤
    healthcheck:
      test:
        - CMD-SHELL
        - >
          if [ -z "${REDIS_PASSWORD}" ]; then
            redis-cli ping;
          else
            redis-cli -a "${REDIS_PASSWORD}" ping;
          fi
      interval: 10s
      timeout: 5s
      retries: 5

    # ç½‘ç»œé…ç½®
    networks:
      - campus

  # ========================================
  # â˜• Backendï¼ˆSpring Boot åç«¯æœåŠ¡ï¼‰
  # ========================================
  # ğŸ¯ é»˜è®¤æ³¨é‡ŠçŠ¶æ€ï¼šæ¨èåœ¨æœ¬åœ° IDE ä¸­è¿è¡Œåç«¯ï¼Œæ–¹ä¾¿è°ƒè¯•
  #
  # ğŸ’¡ å¦‚ä½•å¯ç”¨ Docker ä¸­çš„åç«¯ï¼Ÿ
  #   1. å–æ¶ˆä¸‹æ–¹æ‰€æœ‰ backend ç›¸å…³æ³¨é‡Šï¼ˆæŠŠ # åˆ æ‰ï¼‰
  #   2. ç¡®ä¿ backend/Dockerfile æ–‡ä»¶å­˜åœ¨
  #   3. æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š
  #      docker compose --project-directory . -f docker/docker-compose.yml up -d
  #
  # âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
  #   - å¯ç”¨åä¼šå ç”¨ 8080 ç«¯å£ï¼ˆå¯é€šè¿‡ BACKEND_PORT ç¯å¢ƒå˜é‡ä¿®æ”¹ï¼‰
  #   - æ„å»ºé•œåƒéœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼ˆé¦–æ¬¡å¯åŠ¨è¾ƒæ…¢ï¼‰
  #   - å»ºè®®å¼€å‘æ—¶åœ¨æœ¬åœ°è¿è¡Œï¼Œç”Ÿäº§éƒ¨ç½²æ—¶å†å¯ç”¨ Docker
  # ========================================
  # backend:
  #   # æ„å»ºé…ç½®
  #   # ğŸ“¦ ä»æœ¬åœ° Dockerfile æ„å»ºé•œåƒ
  #   build:
  #     context: ./backend           # æ„å»ºä¸Šä¸‹æ–‡ï¼ˆé¡¹ç›®æ ¹ç›®å½•çš„ backend æ–‡ä»¶å¤¹ï¼‰
  #     dockerfile: Dockerfile       # Dockerfile åç§°
  #     # ğŸ’¡ å¯é€‰å‚æ•°:
  #     # target: production         # å¤šé˜¶æ®µæ„å»ºæ—¶æŒ‡å®šç›®æ ‡é˜¶æ®µ
  #     # args:                      # æ„å»ºå‚æ•°
  #     #   - JAR_FILE=app.jar
  #
  #   # å®¹å™¨åç§°
  #   container_name: campus-backend
  #
  #   # é‡å¯ç­–ç•¥
  #   restart: unless-stopped
  #
  #   # ä¾èµ–å…³ç³»
  #   # âš ï¸ ç­‰å¾… postgres å’Œ redis å¥åº·æ£€æŸ¥é€šè¿‡åå†å¯åŠ¨
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #
  #   # ç¯å¢ƒå˜é‡
  #   # ğŸ“ ä½¿ç”¨ <<: *backend-env å¼•ç”¨å‰é¢å®šä¹‰çš„å¯å¤ç”¨é…ç½®å—
  #   environment:
  #     <<: *backend-env
  #
  #   # ç«¯å£æ˜ å°„
  #   # ğŸ’¡ å¯ä»¥æ”¹æˆ "8081:8080" é¿å…ç«¯å£å†²çª
  #   ports:
  #     - "${BACKEND_PORT:-8080}:8080"
  #
  #   # å¥åº·æ£€æŸ¥
  #   # ğŸ¥ æ£€æŸ¥ Spring Boot Actuator å¥åº·ç«¯ç‚¹
  #   healthcheck:
  #     test: ["CMD", "curl", "-fsS", "http://localhost:8080/api/actuator/health"]
  #     interval: 30s        # æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆåç«¯å¯åŠ¨è¾ƒæ…¢ï¼‰
  #     timeout: 10s         # è¶…æ—¶æ—¶é—´ 10 ç§’
  #     retries: 3           # å¤±è´¥ 3 æ¬¡åæ ‡è®°ä¸º unhealthy
  #
  #   # ç½‘ç»œé…ç½®
  #   networks:
  #     - campus

  # ========================================
  # ğŸŒ Nginxï¼ˆåå‘ä»£ç† + é™æ€èµ„æºæœåŠ¡å™¨ï¼‰
  # ========================================
  # ğŸ¯ é»˜è®¤æ³¨é‡ŠçŠ¶æ€ï¼šæœ¬åœ°å¼€å‘ä¸éœ€è¦ Nginx
  #
  # ğŸ’¡ Nginx çš„ä½œç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
  #   1. åå‘ä»£ç†ï¼šå°†è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
  #   2. é™æ€èµ„æºï¼šæ‰˜ç®¡å‰ç«¯æ‰“åŒ…åçš„é™æ€æ–‡ä»¶ï¼ˆdist/ï¼‰
  #   3. SSL ç»ˆæ­¢ï¼šå¤„ç† HTTPS è¯ä¹¦
  #   4. Gzip å‹ç¼©ï¼šå‡å°‘ä¼ è¾“æ•°æ®é‡
  #
  # ğŸ’¡ æœ¬åœ°å¼€å‘ä¸ºä»€ä¹ˆä¸éœ€è¦ï¼Ÿ
  #   - å‰ç«¯ï¼šVite å¼€å‘æœåŠ¡å™¨ï¼ˆ8210/8220 ç«¯å£ï¼‰æä¾›çƒ­æ›´æ–°
  #   - åç«¯ï¼šSpring Bootï¼ˆ8200 ç«¯å£ï¼‰ç›´æ¥è®¿é—®
  #   - é™æ€èµ„æºï¼šå­˜æ”¾åœ¨ backend/src/main/resources/static/
  #
  # ğŸ’¡ å¦‚ä½•å¯ç”¨ Nginxï¼ˆç”Ÿäº§éƒ¨ç½²ï¼‰ï¼Ÿ
  #   1. å–æ¶ˆä¸‹æ–¹æ‰€æœ‰ nginx ç›¸å…³æ³¨é‡Š
  #   2. ç¡®ä¿å‰ç«¯å·²æ‰“åŒ…ï¼ˆnpm run buildï¼‰
  #   3. ä¿®æ”¹ volumes æŒ‚è½½å‰ç«¯ dist ç›®å½•
  #   4. æ‰§è¡Œå¯åŠ¨å‘½ä»¤ï¼š
  #      docker compose --project-directory . -f docker/docker-compose.yml up -d
  # ========================================
  # nginx:
  #   # Docker é•œåƒ
  #   # ğŸ’¡ alpine ç‰ˆæœ¬ä½“ç§¯å°ï¼ˆ~40MBï¼‰ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ
  #   # å¯é€‰ç‰ˆæœ¬: nginx:1.27-alpine, nginx:1.26-alpine, nginx:latest
  #   image: nginx:1.27-alpine
  #
  #   # å®¹å™¨åç§°
  #   container_name: campus-nginx
  #
  #   # é‡å¯ç­–ç•¥
  #   restart: unless-stopped
  #
  #   # ä¾èµ–å…³ç³»
  #   # âš ï¸ å¦‚æœå¯ç”¨äº† backend æœåŠ¡ï¼Œå–æ¶ˆä¸‹æ–¹æ³¨é‡Šä»¥ç­‰å¾… backend å¯åŠ¨
  #   # depends_on:
  #   #   - backend
  #
  #   # ç«¯å£æ˜ å°„
  #   # ğŸ“ 80 ç«¯å£ç”¨äº HTTP è®¿é—®
  #   # ğŸ’¡ HTTPS éœ€è¦æ”¹æˆ "443:443" å¹¶æŒ‚è½½è¯ä¹¦
  #   ports:
  #     - "80:80"
  #     # - "443:443"  # ğŸ’¡ å¯é€‰: HTTPS ç«¯å£
  #
  #   # æ•°æ®å·æŒ‚è½½
  #   # ğŸ“ :ro è¡¨ç¤ºåªè¯»æŒ‚è½½ï¼Œé¿å…å®¹å™¨ä¿®æ”¹é…ç½®æ–‡ä»¶
  #   volumes:
  #     - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro           # Nginx ä¸»é…ç½®æ–‡ä»¶
  #     - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro                   # è™šæ‹Ÿä¸»æœºé…ç½®ç›®å½•
  #     # - ./ssl:/etc/nginx/ssl:ro                             # ğŸ’¡ å¯é€‰: SSL è¯ä¹¦ç›®å½•
  #     # - ./frontend/packages/portal/dist:/usr/share/nginx/html:ro           # ğŸ’¡ ç”Ÿäº§ç¯å¢ƒï¼šå‰ç«¯é™æ€èµ„æº
  #
  #   # å¥åº·æ£€æŸ¥
  #   # ğŸ¥ æ£€æŸ¥ Nginx å¥åº·ç«¯ç‚¹
  #   healthcheck:
  #     test: ["CMD-SHELL", "wget -q -O - http://localhost/health || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #
  #   # ç½‘ç»œé…ç½®
  #   networks:
  #     - campus

  # ========================================
  # ğŸ“§ MailHogï¼ˆå¼€å‘ç¯å¢ƒé‚®ä»¶æµ‹è¯•å·¥å…·ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: æ‹¦æˆªæ‰€æœ‰å‘é€çš„é‚®ä»¶ï¼Œæä¾› Web ç•Œé¢æŸ¥çœ‹
  # ğŸ”§ å¯ç”¨æ–¹å¼: docker compose --profile devtools up -d
  # ğŸŒ è®¿é—®åœ°å€: http://localhost:8025
  # ========================================
  mailhog:
    # Docker é•œåƒ
    image: mailhog/mailhog:v1.0.1

    # å®¹å™¨åç§°
    container_name: campus-mailhog

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # é…ç½®æ–‡ä»¶åˆ†ç»„ï¼ˆProfilesï¼‰
    # ğŸ’¡ åªæœ‰ä½¿ç”¨ --profile devtools æ—¶æ‰ä¼šå¯åŠ¨
    profiles: ["devtools"]

    # ç«¯å£æ˜ å°„
    ports:
      - "1025:1025"   # SMTP ç«¯å£ï¼ˆåç«¯è¿æ¥æ­¤ç«¯å£å‘é‚®ä»¶ï¼‰
      - "8025:8025"   # Web UI ç«¯å£ï¼ˆæµè§ˆå™¨è®¿é—®æ­¤ç«¯å£æŸ¥çœ‹é‚®ä»¶ï¼‰

    # ç½‘ç»œé…ç½®
    networks:
      - campus

  # ========================================
  # ğŸ“Š Prometheusï¼ˆç›‘æ§æ•°æ®æ”¶é›†ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: æ”¶é›†åº”ç”¨æŒ‡æ ‡æ•°æ®ï¼ˆCPUã€å†…å­˜ã€è¯·æ±‚é‡ç­‰ï¼‰
  # ğŸ”§ å¯ç”¨æ–¹å¼: docker compose --profile observability up -d
  # ğŸŒ è®¿é—®åœ°å€: http://localhost:9090
  # ========================================
  prometheus:
    # Docker é•œåƒ
    image: prom/prometheus:v2.53.0

    # å®¹å™¨åç§°
    container_name: campus-prometheus

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # é…ç½®æ–‡ä»¶åˆ†ç»„
    profiles: ["observability"]

    # å¯åŠ¨å‘½ä»¤å‚æ•°
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"    # é…ç½®æ–‡ä»¶è·¯å¾„
      - "--storage.tsdb.path=/prometheus"                 # æ•°æ®å­˜å‚¨è·¯å¾„
      # - "--storage.tsdb.retention.time=30d"             # ğŸ’¡ å¯é€‰: æ•°æ®ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤ 15 å¤©ï¼‰
      # - "--web.enable-admin-api"                        # ğŸ’¡ å¯é€‰: å¯ç”¨ç®¡ç† API

    # æ•°æ®å·æŒ‚è½½
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro  # Prometheus é…ç½®æ–‡ä»¶
      - prometheus_data:/prometheus                                     # æ—¶åºæ•°æ®åº“å­˜å‚¨

    # ç«¯å£æ˜ å°„
    ports:
      - "9090:9090"

    # ç½‘ç»œé…ç½®
    networks:
      - campus

  # ========================================
  # ğŸ“ˆ Grafanaï¼ˆç›‘æ§æ•°æ®å¯è§†åŒ–ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: å±•ç¤º Prometheus æ”¶é›†çš„ç›‘æ§æ•°æ®
  # ğŸ”§ å¯ç”¨æ–¹å¼: docker compose --profile observability up -d
  # ğŸŒ è®¿é—®åœ°å€: http://localhost:3000
  # ğŸ”‘ é»˜è®¤è´¦å·: admin / adminï¼ˆé¦–æ¬¡ç™»å½•éœ€ä¿®æ”¹å¯†ç ï¼‰
  # ========================================
  grafana:
    # Docker é•œåƒ
    image: grafana/grafana:11.1.0

    # å®¹å™¨åç§°
    container_name: campus-grafana

    # é‡å¯ç­–ç•¥
    restart: unless-stopped

    # é…ç½®æ–‡ä»¶åˆ†ç»„
    profiles: ["observability"]

    # ç¯å¢ƒå˜é‡
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}         # ç®¡ç†å‘˜ç”¨æˆ·å
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin} # ç®¡ç†å‘˜å¯†ç ï¼ˆâš ï¸ ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹ï¼ï¼‰
      # ğŸ’¡ å…¶ä»–å¯é€‰é…ç½®:
      # GF_SECURITY_ALLOW_EMBEDDING: "true"                         # å…è®¸åµŒå…¥ iframe
      # GF_AUTH_ANONYMOUS_ENABLED: "true"                           # å…è®¸åŒ¿åè®¿é—®
      # GF_INSTALL_PLUGINS: "grafana-clock-panel,grafana-simple-json-datasource"  # å®‰è£…æ’ä»¶

    # ç«¯å£æ˜ å°„
    ports:
      - "3000:3000"

    # æ•°æ®å·æŒ‚è½½
    volumes:
      - grafana_data:/var/lib/grafana                                           # Grafana æ•°æ®å­˜å‚¨
      - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources:ro          # æ•°æ®æºé…ç½®
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro            # ä»ªè¡¨æ¿é…ç½®

    # ä¾èµ–å…³ç³»
    depends_on:
      - prometheus

    # ç½‘ç»œé…ç½®
    networks:
      - campus

  # ========================================
  # ğŸŒ‰ ngrokï¼ˆå°†æœ¬åœ°æœåŠ¡æš´éœ²ä¸ºå…¬ç½‘åœ°å€ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: åŒæ—¶æš´éœ²å‰åç«¯ä¸‰ä¸ªæœåŠ¡åˆ°å…¬ç½‘
  #   - 8200: åç«¯APIï¼ˆæ”¯ä»˜å›è°ƒå¿…éœ€ï¼‰
  #   - 8210: å‰ç«¯ç®¡ç†ç«¯
  #   - 8220: å‰ç«¯ç”¨æˆ·ç«¯
  # ğŸ”§ å¯ç”¨æ–¹å¼: docker compose --project-directory . -f docker/docker-compose.yml --profile tunnel up -d
  # ğŸŒ è®¿é—®ç®¡ç†ç•Œé¢: http://localhost:4040
  ngrok:
    image: ngrok/ngrok:3
    container_name: campus-ngrok
    restart: unless-stopped
    profiles: ["tunnel"]
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:?è¯·åœ¨ .env ä¸­è®¾ç½® NGROK_AUTHTOKEN}
    # ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨å¤šéš§é“
    command: ["start", "--all", "--config", "/etc/ngrok.yml"]
    volumes:
      - ./docker/ngrok/ngrok.yml:/etc/ngrok.yml:ro
    ports:
      - "4040:4040"   # ngrok Webç®¡ç†ç•Œé¢
    networks:
      - campus

  # ==========================================================
  # ğŸš€ å¯é€‰æ‰©å±•æœåŠ¡ï¼ˆæ³¨é‡Šå½¢å¼ä¿ç•™ï¼ŒæŒ‰éœ€å¯ç”¨ï¼‰
  # ==========================================================

  # ========================================
  # ğŸ“Š PostgreSQL åªè¯»ä»åº“ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: åˆ†æ‹…ä¸»åº“è¯»å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
  # ğŸ”§ å¯ç”¨æ–¹å¼:
  #   1. å–æ¶ˆä»¥ä¸‹æ³¨é‡Š
  #   2. åœ¨ .env ä¸­è®¾ç½® REPLICATION_PASSWORD
  #   3. ä¿®æ”¹åç«¯ä»£ç å®ç°è¯»å†™åˆ†ç¦»é€»è¾‘
  # ğŸ“ è¯´æ˜: ä»åº“è‡ªåŠ¨åŒæ­¥ä¸»åº“æ•°æ®ï¼Œåªèƒ½è¯»å–ï¼Œä¸èƒ½å†™å…¥
  # ========================================
  # postgres-replica-1:
  #   image: postgres:16
  #   container_name: campus-postgres-replica-1
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_USER: ${DB_USERNAME:-postgres}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
  #     POSTGRES_DB: ${DB_NAME:-campus_marketplace_prod}
  #     PRIMARY_HOST: postgres                                          # ä¸»åº“ä¸»æœºå
  #     PRIMARY_PORT: 5432                                              # ä¸»åº“ç«¯å£
  #     REPLICATION_USER: replicator                                    # å¤åˆ¶ç”¨æˆ·å
  #     REPLICATION_PASSWORD: ${REPLICATION_PASSWORD:-replicator}       # å¤åˆ¶å¯†ç ï¼ˆâš ï¸ åŠ¡å¿…ä¿®æ”¹ï¼ï¼‰
  #   depends_on:
  #     - postgres
  #   networks:
  #     - campus

  # ========================================
  # ğŸ”´ Redis Sentinelï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰
  # ========================================
  # ğŸ¯ ç”¨é€”: Redis ä¸»ä»è‡ªåŠ¨æ•…éšœè½¬ç§»
  # ğŸ”§ å¯ç”¨æ–¹å¼:
  #   1. å–æ¶ˆä»¥ä¸‹æ³¨é‡Šï¼ˆéœ€è¦ 3 ä¸ª Sentinel èŠ‚ç‚¹ï¼‰
  #   2. åœ¨ .env ä¸­è®¾ç½® REDIS_SENTINEL_MASTER å’Œ REDIS_SENTINEL_NODES
  #   3. ä¿®æ”¹åç«¯ Redis é…ç½®ä¸º Sentinel æ¨¡å¼
  # ğŸ“ è¯´æ˜: Sentinel ç›‘æ§ Redis ä¸»ä»ï¼Œä¸»èŠ‚ç‚¹å®•æœºæ—¶è‡ªåŠ¨åˆ‡æ¢
  # ========================================
  # redis-sentinel-1:
  #   image: redis:7.4
  #   container_name: campus-redis-sentinel-1
  #   restart: unless-stopped
  #   command: >
  #     sh -c "sed -e 's/<REDIS_PASSWORD>/'\"$${REDIS_PASSWORD}\"'/g' /etc/redis/sentinel.conf > /tmp/sentinel.conf
  #     && exec redis-sentinel /tmp/sentinel.conf"
  #   volumes:
  #     - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
  #   depends_on:
  #     - redis
  #   networks:
  #     - campus
  #
  # redis-sentinel-2:
  #   image: redis:7.4
  #   container_name: campus-redis-sentinel-2
  #   restart: unless-stopped
  #   command: >
  #     sh -c "sed -e 's/<REDIS_PASSWORD>/'\"$${REDIS_PASSWORD}\"'/g' /etc/redis/sentinel.conf > /tmp/sentinel.conf
  #     && exec redis-sentinel /tmp/sentinel.conf"
  #   volumes:
  #     - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
  #   depends_on:
  #     - redis
  #   networks:
  #     - campus
  #
  # redis-sentinel-3:
  #   image: redis:7.4
  #   container_name: campus-redis-sentinel-3
  #   restart: unless-stopped
  #   command: >
  #     sh -c "sed -e 's/<REDIS_PASSWORD>/'\"$${REDIS_PASSWORD}\"'/g' /etc/redis/sentinel.conf > /tmp/sentinel.conf
  #     && exec redis-sentinel /tmp/sentinel.conf"
  #   volumes:
  #     - ./redis/sentinel.conf:/etc/redis/sentinel.conf:ro
  #   depends_on:
  #     - redis
  #   networks:
  #     - campus

  # ==========================================================
  # ğŸš€ æ¨ªå‘æ‰©å®¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
  # ==========================================================
  # ğŸ’¡ åç«¯å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿæ‰©å®¹ä¸ºå¤šå®ä¾‹:
  #    docker compose up --scale backend=3
  #
  # âš ï¸ æ³¨æ„äº‹é¡¹:
  #   1. éœ€è¦ä¿®æ”¹ Nginx é…ç½®ä¸º upstream è´Ÿè½½å‡è¡¡æ¨¡å¼
  #   2. æ‰©å®¹å‰ç¡®ä¿åº”ç”¨æ˜¯æ— çŠ¶æ€çš„ï¼ˆä¼šè¯å­˜å‚¨åœ¨ Redisï¼‰
  #   3. æ•°æ®åº“è¿æ¥æ± éœ€è¦æ ¹æ®å®ä¾‹æ•°é‡è°ƒæ•´
  #
  # ğŸ“ Nginx upstream é…ç½®ç¤ºä¾‹:
  #    upstream backend {
  #        server backend:8080 weight=1;
  #        # Docker Compose ä¼šè‡ªåŠ¨ä¸ºæ‰©å®¹çš„å®ä¾‹åˆ†é…ç«¯å£
  #    }
  # ==========================================================

# ==========================================================
# ğŸ“¡ ç½‘ç»œé…ç½®
# ==========================================================
# ğŸ’¡ æ‰€æœ‰æœåŠ¡éƒ½åœ¨åŒä¸€ä¸ª bridge ç½‘ç»œä¸­ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡åäº’ç›¸è®¿é—®
# ğŸ“ ä¾‹å¦‚: åç«¯è¿æ¥æ•°æ®åº“ä½¿ç”¨ postgres:5432
# ==========================================================
networks:
  campus:
    driver: bridge
    # ğŸ’¡ å¯é€‰é…ç½®:
    # driver_opts:
    #   com.docker.network.bridge.name: campus-bridge  # è‡ªå®šä¹‰ç½‘æ¡¥åç§°
    # ipam:                                            # è‡ªå®šä¹‰ IP åœ°å€ç®¡ç†
    #   driver: default
    #   config:
    #     - subnet: 172.28.0.0/16
    #       gateway: 172.28.0.1

# ==========================================================
# ğŸ’¾ æ•°æ®å·é…ç½®ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰
# ==========================================================
# ğŸ’¡ Docker Volume è‡ªåŠ¨ç®¡ç†ï¼Œæ•°æ®å­˜å‚¨åœ¨ Docker ç›®å½•
# ğŸ“ æŸ¥çœ‹æ•°æ®å·: docker volume ls
# ğŸ“ æŸ¥çœ‹è·¯å¾„: docker volume inspect campus-lite-marketplace_postgres_data
# ğŸ“ å¤‡ä»½æ•°æ®: docker run --rm -v postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres_backup.tar.gz /data
# ==========================================================
volumes:
  postgres_data:
    # driver: local                                    # é»˜è®¤é©±åŠ¨
    # driver_opts:                                     # ğŸ’¡ å¯é€‰: æŒ‚è½½åˆ°å®¿ä¸»æœºæŒ‡å®šç›®å½•
    #   type: none
    #   o: bind
    #   device: /data/postgres

  redis_data:
    # driver: local

  prometheus_data:
    # driver: local

  grafana_data:
    # driver: local

# ==========================================================
# ğŸ“š å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥
# ==========================================================
# ğŸš€ å¯åŠ¨æœåŠ¡:
#   docker compose --project-directory . -f docker/docker-compose.yml up -d
#
# ğŸ›‘ åœæ­¢æœåŠ¡:
#   docker compose --project-directory . -f docker/docker-compose.yml down
#
# ğŸ”„ é‡å¯æœåŠ¡:
#   docker compose --project-directory . -f docker/docker-compose.yml restart
#
# ğŸ“‹ æŸ¥çœ‹æ—¥å¿—:
#   docker compose --project-directory . -f docker/docker-compose.yml logs -f [æœåŠ¡å]
#
# ğŸ“Š æŸ¥çœ‹çŠ¶æ€:
#   docker compose --project-directory . -f docker/docker-compose.yml ps
#
# ğŸ—‘ï¸ åˆ é™¤æœåŠ¡å’Œæ•°æ®å·:
#   docker compose --project-directory . -f docker/docker-compose.yml down -v
#
# ğŸ”§ è¿›å…¥å®¹å™¨:
#   docker exec -it campus-backend sh
#
# ğŸ“¦ é‡æ–°æ„å»ºé•œåƒ:
#   docker compose --project-directory . -f docker/docker-compose.yml build --no-cache
#
# ğŸš€ æ‰©å®¹åç«¯:
#   docker compose --project-directory . -f docker/docker-compose.yml up -d --scale backend=3
# ==========================================================
