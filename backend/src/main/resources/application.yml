spring:
  application:
    name: ${APP_NAME:campus-marketplace}
  
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  # 数据源配置
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:campus_marketplace_dev}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      minimum-idle: ${DB_POOL_MIN_IDLE:10}
      maximum-pool-size: ${DB_POOL_MAX_SIZE:50}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${DB_IDLE_TIMEOUT:600000}
      max-lifetime: ${DB_MAX_LIFETIME:1800000}
      pool-name: ${DB_POOL_NAME:CampusMarketplaceHikariCP}
  
  # JPA 配置
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: ${JPA_DDL_AUTO:update}
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: ${JPA_FORMAT_SQL:true}
        # 懒加载配置
        enable_lazy_load_no_trans: ${JPA_ENABLE_LAZY_NO_TRANS:false}
        # 批量操作配置
        jdbc:
          batch_size: ${JPA_BATCH_SIZE:50}
        order_inserts: ${JPA_ORDER_INSERTS:true}
        order_updates: ${JPA_ORDER_UPDATES:true}
        # 二级缓存配置
        cache:
          use_second_level_cache: ${HIBERNATE_SECOND_LEVEL_CACHE:true}
          use_query_cache: ${HIBERNATE_QUERY_CACHE:true}
          region:
            factory_class: ${HIBERNATE_CACHE_FACTORY:org.redisson.hibernate.RedissonRegionFactory}
  
  # Redis 配置
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      sentinel:
        master: ${REDIS_SENTINEL_MASTER:}
        nodes: ${REDIS_SENTINEL_NODES:}
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:50}
          max-idle: ${REDIS_POOL_MAX_IDLE:20}
          min-idle: ${REDIS_POOL_MIN_IDLE:10}
          max-wait: 3000ms
  
  # 文件上传配置
  servlet:
    multipart:
      max-file-size: ${FILE_MAX_SIZE:5MB}
      max-request-size: ${FILE_MAX_REQUEST_SIZE:10MB}
      enabled: ${FILE_UPLOAD_ENABLED:true}

# JWT 配置
jwt:
  secret: ${JWT_SECRET:campus-marketplace-secret-key-must-be-at-least-256-bits-long-for-hs256-algorithm}
  expiration: ${JWT_EXPIRATION:7200000}
  header: ${JWT_HEADER:Authorization}
  prefix: ${JWT_PREFIX:Bearer }

# 日志配置
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.campus.marketplace: ${LOG_LEVEL_APP:DEBUG}
    org.hibernate.SQL: ${LOG_LEVEL_SQL:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_LEVEL_BINDER:TRACE}
    org.springframework.security: ${LOG_LEVEL_SPRING_SECURITY:DEBUG}
  pattern:
    console: ${LOG_PATTERN_CONSOLE:"%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"}
    file: ${LOG_PATTERN_FILE:"%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"}
  file:
    name: ${LOG_FILE_PATH:logs/campus-marketplace.log}
    max-size: ${LOG_FILE_MAX_SIZE:10MB}
    max-history: ${LOG_FILE_MAX_HISTORY:30}

# Actuator 监控配置
management:
  endpoints:
    web:
      exposure:
        # 暴露的端点（生产环境应限制）
        include: ${ACTUATOR_ENDPOINTS:health,info,metrics,prometheus,loggers,caches,threaddump,heapdump}
        # 排除敏感端点
        exclude: ${ACTUATOR_EXCLUDE:shutdown}
      base-path: ${ACTUATOR_BASE_PATH:/actuator}
  endpoint:
    health:
      show-details: ${ACTUATOR_HEALTH_SHOW_DETAILS:when-authorized}
      # 健康检查探针
      probes:
        enabled: true
    # 启用日志级别动态调整
    loggers:
      enabled: true
  # Metrics 配置
  metrics:
    export:
      prometheus:
        enabled: ${PROMETHEUS_ENABLED:true}
    distribution:
      percentiles-histogram:
        http.server.requests: ${METRICS_HTTP_HISTOGRAM:true}
    tags:
      application: ${spring.application.name}
  # 追踪配置
  tracing:
    sampling:
      probability: ${TRACING_PROBABILITY:1.0}

# 服务器配置
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: ${APP_CONTEXT_PATH:/api}
  tomcat:
    threads:
      max: ${TOMCAT_MAX_THREADS:200}
      min-spare: ${TOMCAT_MIN_SPARE_THREADS:10}

# 通知与合规配置
notifications:
  email:
    rate:
      perMinute: ${NOTIF_EMAIL_PER_MINUTE:20}
  webpush:
    enabled: ${WEBPUSH_ENABLED:false}

compliance:
  text:
    action: ${COMPLIANCE_TEXT_ACTION:REVIEW} # BLOCK/REVIEW/PASS
  image:
    enabled: ${COMPLIANCE_IMAGE_ENABLED:false}

# 支付宝支付配置
alipay:
  app-id: ${ALIPAY_APP_ID:}
  private-key: ${ALIPAY_PRIVATE_KEY:}
  alipay-public-key: ${ALIPAY_PUBLIC_KEY:}
  gateway-url: ${ALIPAY_GATEWAY_URL:https://openapi-sandbox.dl.alipaydev.com/gateway.do}
  charset: ${ALIPAY_CHARSET:UTF-8}
  format: ${ALIPAY_FORMAT:json}
  sign-type: ${ALIPAY_SIGN_TYPE:RSA2}
  notify-url: ${ALIPAY_NOTIFY_URL:http://localhost:8080/api/payment/alipay/notify}
  return-url: ${ALIPAY_RETURN_URL:http://localhost:3000/payment/result}

# 微信支付配置
wechat:
  pay:
    # 版本选择：v2=沙箱环境（推荐开发测试），v3=正式/沙箱环境
    version: ${WECHAT_PAY_VERSION:v3}
    
    # V3配置（正式环境或V3沙箱）
    app-id: ${WECHAT_APP_ID:}
    mch-id: ${WECHAT_MCH_ID:}
    private-key-path: ${WECHAT_PRIVATE_KEY_PATH:}
    merchant-serial-number: ${WECHAT_MERCHANT_SERIAL_NUMBER:}
    api-v3-key: ${WECHAT_API_V3_KEY:}
    notify-url: ${WECHAT_NOTIFY_URL:http://localhost:8080/api/payment/wechat/notify}
    
    # V2配置（沙箱环境）
    v2:
      app-id: ${WECHAT_V2_APP_ID:}
      mch-id: ${WECHAT_V2_MCH_ID:}
      mch-key: ${WECHAT_V2_MCH_KEY:}
      key-path: ${WECHAT_V2_KEY_PATH:}
      use-sandbox: ${WECHAT_V2_USE_SANDBOX:true}
      notify-url: ${WECHAT_V2_NOTIFY_URL:http://localhost:8080/api/payment/wechat/notify}

# OpenAPI/Swagger 开关
springdoc:
  api-docs:
    enabled: ${SPRINGDOC_ENABLED:true}
  swagger-ui:
    enabled: ${SWAGGER_UI_ENABLED:true}
