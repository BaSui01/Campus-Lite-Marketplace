spring:
  application:
    name: ${APP_NAME:campus-marketplace}
  
  profiles:
    active: ${APP_ENV:${SPRING_PROFILES_ACTIVE:dev}}
  
  # æ•°æ®æºé…ç½®
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:campus_marketplace_dev}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      minimum-idle: ${DB_POOL_MIN_IDLE:10}
      maximum-pool-size: ${DB_POOL_MAX_SIZE:50}
      connection-timeout: ${DB_CONNECTION_TIMEOUT:30000}
      idle-timeout: ${DB_IDLE_TIMEOUT:600000}
      max-lifetime: ${DB_MAX_LIFETIME:1800000}
      pool-name: ${DB_POOL_NAME:CampusMarketplaceHikariCP}
  
  # JPA é…ç½®
  jpa:
    hibernate:
      # ä½¿ç”¨ validate æ¨¡å¼ï¼Œé…åˆ Flyway ç®¡ç†æ•°æ®åº“è¿ç§» ğŸ¯
      ddl-auto: ${JPA_DDL_AUTO:validate}
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: ${JPA_FORMAT_SQL:true}
        # Hibernate Schema Management é…ç½® ğŸ¯
        #   - halt_on_error: false  å¿½ç•¥ç´¢å¼•é‡å¤é”™è¯¯ï¼ˆæ²»æ ‡ä¸æ²»æœ¬ï¼‰
        #   - schema_management_tool.hbm2ddl.jdbc_metadata_extraction_strategy: individually  é€ä¸ªæå–å…ƒæ•°æ®
        hbm2ddl:
          halt_on_error: false
        schema_management_tool:
          hbm2ddl:
            jdbc_metadata_extraction_strategy: individually
        # æ‡’åŠ è½½é…ç½®
        enable_lazy_load_no_trans: ${JPA_ENABLE_LAZY_NO_TRANS:false}
        # æ‰¹é‡æ“ä½œé…ç½®
        jdbc:
          batch_size: ${JPA_BATCH_SIZE:50}
        order_inserts: ${JPA_ORDER_INSERTS:true}
        order_updates: ${JPA_ORDER_UPDATES:true}
        # äºŒçº§ç¼“å­˜é…ç½®
        cache:
          use_second_level_cache: ${HIBERNATE_SECOND_LEVEL_CACHE:true}
          use_query_cache: ${HIBERNATE_QUERY_CACHE:true}
          region:
            factory_class: ${HIBERNATE_CACHE_FACTORY:org.redisson.hibernate.RedissonRegionFactory}

  # Flyway æ•°æ®åº“è¿ç§»é…ç½®
  flyway:
    enabled: ${FLYWAY_ENABLED:true}
    baseline-on-migrate: ${FLYWAY_BASELINE_ON_MIGRATE:true}
    baseline-version: ${FLYWAY_BASELINE_VERSION:0}
    locations: ${FLYWAY_LOCATIONS:classpath:db/migration}
    validate-on-migrate: ${FLYWAY_VALIDATE_ON_MIGRATE:true}

  # Redis é…ç½®
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      # ä½¿ç”¨ Redisson çš„ç‹¬ç«‹é…ç½®æ–‡ä»¶ï¼Œé¿å…è¯¯è§¦å‘å“¨å…µæ¨¡å¼
      redisson:
        file: classpath:redisson.yaml
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:50}
          max-idle: ${REDIS_POOL_MAX_IDLE:20}
          min-idle: ${REDIS_POOL_MIN_IDLE:10}
          max-wait: 3000ms
      repositories:
        enabled: false

  # ä¾› Redisson Starter è¯»å–çš„æ—§å‰ç¼€ï¼ˆä¸ Spring Boot 3 å…¼å®¹ï¼‰
  redis:
    redisson:
      file: classpath:redisson.yaml
  
  # æ–‡ä»¶ä¸Šä¼ é…ç½®
  servlet:
    multipart:
      max-file-size: ${FILE_MAX_SIZE:5MB}
      max-request-size: ${FILE_MAX_REQUEST_SIZE:10MB}
      enabled: ${FILE_UPLOAD_ENABLED:true}

  # é‚®ä»¶é…ç½®ï¼ˆä½¿ç”¨çœŸå® SMTPï¼‰
  mail:
    host: ${MAIL_HOST:}
    port: ${MAIL_PORT:}
    username: ${MAIL_USERNAME:}
    password: ${MAIL_PASSWORD:}
    default-encoding: UTF-8
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: ${MAIL_SSL_ENABLE:true}
          starttls:
            enable: ${MAIL_STARTTLS_ENABLE:false}
    from: ${MAIL_FROM:${MAIL_USERNAME:}}

# JWT é…ç½®
jwt:
  secret: ${JWT_SECRET:5bwzFhN2dpPiac1wgPaFgb5iu_lEB5JrSxZqv-WIOwRiE_dQOE-fMFxy24-iOXgWm1NxybaJMrkbCXG9mY0a4Q}
  expiration: ${JWT_EXPIRATION:7200000}
  header: ${JWT_HEADER:Authorization}
  prefix: ${JWT_PREFIX:Bearer }

# AES åŠ å¯†é…ç½®
encrypt:
  aes:
    key: ${AES_KEY:JrOagghJ4Ot3e63ObB1CJtOjvwYnk1chSwXR86E_MJs}

# æ—¥å¿—é…ç½®
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.campus.marketplace: ${LOG_LEVEL_APP:DEBUG}
    org.hibernate.SQL: ${LOG_LEVEL_SQL:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_LEVEL_BINDER:TRACE}
    org.springframework.security: ${LOG_LEVEL_SPRING_SECURITY:DEBUG}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: ${LOG_PATTERN_FILE:"%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"}
  file:
    name: ${LOG_FILE_PATH:logs/campus-marketplace.log}
    max-size: ${LOG_FILE_MAX_SIZE:10MB}
    max-history: ${LOG_FILE_MAX_HISTORY:30}

# Actuator ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        # æš´éœ²çš„ç«¯ç‚¹ï¼ˆç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶ï¼‰
        include: ${ACTUATOR_ENDPOINTS:health,info,metrics,prometheus,loggers,caches,threaddump,heapdump}
        # æ’é™¤æ•æ„Ÿç«¯ç‚¹
        exclude: ${ACTUATOR_EXCLUDE:shutdown}
      # BaSuiä¸´æ—¶ä¿®å¤ï¼šç›´æ¥ç¡¬ç¼–ç  /actuator
      base-path: /actuator
  endpoint:
    health:
      show-details: ${ACTUATOR_HEALTH_SHOW_DETAILS:when-authorized}
      # å¥åº·æ£€æŸ¥æ¢é’ˆ
      probes:
        enabled: true
    # å¯ç”¨æ—¥å¿—çº§åˆ«åŠ¨æ€è°ƒæ•´
    loggers:
      enabled: true
  # Metrics é…ç½®
  metrics:
    export:
      prometheus:
        enabled: ${PROMETHEUS_ENABLED:true}
    distribution:
      percentiles-histogram:
        http.server.requests: ${METRICS_HTTP_HISTOGRAM:true}
    tags:
      application: ${spring.application.name}
  # è¿½è¸ªé…ç½®
  tracing:
    sampling:
      probability: ${TRACING_PROBABILITY:1.0}

# æœåŠ¡å™¨é…ç½®
server:
  port: ${SERVER_PORT:8080}
  servlet:
    # BaSuiä¸´æ—¶ä¿®å¤ï¼šç›´æ¥ç¡¬ç¼–ç  /apiï¼Œè·³è¿‡ç¯å¢ƒå˜é‡
    context-path: /api
  tomcat:
    threads:
      max: ${TOMCAT_MAX_THREADS:200}
      min-spare: ${TOMCAT_MIN_SPARE_THREADS:10}

# é€šçŸ¥ä¸åˆè§„é…ç½®
notifications:
  email:
    rate:
      perMinute: ${NOTIF_EMAIL_PER_MINUTE:20}
  webpush:
    enabled: ${WEBPUSH_ENABLED:false}

# çŸ­ä¿¡é…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰
sms:
  provider: ${SMS_PROVIDER:aliyun}
  aliyun:
    accessKeyId: ${ALIYUN_SMS_ACCESS_KEY_ID:}
    accessKeySecret: ${ALIYUN_SMS_ACCESS_KEY_SECRET:}
    signName: ${ALIYUN_SMS_SIGN_NAME:}
    templateRegister: ${ALIYUN_SMS_TEMPLATE_REGISTER:SMS_0000001}
    templateReset: ${ALIYUN_SMS_TEMPLATE_RESET:SMS_0000002}

compliance:
  text:
    action: ${COMPLIANCE_TEXT_ACTION:REVIEW} # BLOCK/REVIEW/PASS
  image:
    enabled: ${COMPLIANCE_IMAGE_ENABLED:false}

# æ”¯ä»˜å®æ”¯ä»˜é…ç½®
alipay:
  app-id: ${ALIPAY_APP_ID:}
  private-key: ${ALIPAY_PRIVATE_KEY:}
  alipay-public-key: ${ALIPAY_PUBLIC_KEY:}
  gateway-url: ${ALIPAY_GATEWAY_URL:https://openapi-sandbox.dl.alipaydev.com/gateway.do}
  charset: ${ALIPAY_CHARSET:UTF-8}
  format: ${ALIPAY_FORMAT:json}
  sign-type: ${ALIPAY_SIGN_TYPE:RSA2}
  notify-url: ${ALIPAY_NOTIFY_URL:http://localhost:8080/api/payment/alipay/notify}
  return-url: ${ALIPAY_RETURN_URL:http://localhost:3000/payment/result}

# å¾®ä¿¡æ”¯ä»˜é…ç½®
wechat:
  pay:
    # ç‰ˆæœ¬é€‰æ‹©ï¼šv2=æ²™ç®±ç¯å¢ƒï¼ˆæ¨èå¼€å‘æµ‹è¯•ï¼‰ï¼Œv3=æ­£å¼/æ²™ç®±ç¯å¢ƒ
    version: ${WECHAT_PAY_VERSION:v3}
    
    # V3é…ç½®ï¼ˆæ­£å¼ç¯å¢ƒæˆ–V3æ²™ç®±ï¼‰
    app-id: ${WECHAT_APP_ID:}
    mch-id: ${WECHAT_MCH_ID:}
    private-key-path: ${WECHAT_PRIVATE_KEY_PATH:}
    merchant-serial-number: ${WECHAT_MERCHANT_SERIAL_NUMBER:}
    api-v3-key: ${WECHAT_API_V3_KEY:}
    notify-url: ${WECHAT_NOTIFY_URL:http://localhost:8080/api/payment/wechat/notify}
    
    # V2é…ç½®ï¼ˆæ²™ç®±ç¯å¢ƒï¼‰
    v2:
      app-id: ${WECHAT_V2_APP_ID:}
      mch-id: ${WECHAT_V2_MCH_ID:}
      mch-key: ${WECHAT_V2_MCH_KEY:}
      key-path: ${WECHAT_V2_KEY_PATH:}
      use-sandbox: ${WECHAT_V2_USE_SANDBOX:true}
      notify-url: ${WECHAT_V2_NOTIFY_URL:http://localhost:8080/api/payment/wechat/notify}

# åº”ç”¨çº§è‡ªå®šä¹‰é…ç½®
app:
  cache:
    prewarm:
      enabled: ${APP_CACHE_PREWARM_ENABLED:false}
  redis:
    mode: ${APP_REDIS_MODE:redis} # å¯é€‰ redis/in-memoryï¼Œå¼€å‘é»˜è®¤ä½¿ç”¨ redis

# OpenAPI/Swagger å¼€å…³
springdoc:
  api-docs:
    enabled: ${SPRINGDOC_ENABLED:true}
  swagger-ui:
    enabled: ${SWAGGER_UI_ENABLED:true}
    groups-order: ASC
    tags-sorter: alpha
    operations-sorter: alpha
    display-request-duration: true
    urls-primary-name: å‰å°æ¥å£
  group-configs:
    - group: å‰å°æ¥å£
      paths-to-match:
        - /api/**
      paths-to-exclude:
        - /api/admin/**
    - group: åå°æ¥å£
      paths-to-match:
        - /api/admin/**

---
spring:
  config:
    activate:
      on-profile: dev
  jpa:
    hibernate:
      # å¼€å‘ç¯å¢ƒä¹Ÿä½¿ç”¨ validate æ¨¡å¼ï¼Œé…åˆ Flyway ç®¡ç†æ•°æ®åº“è¿ç§» ğŸ¯
      ddl-auto: ${DEV_JPA_DDL_AUTO:validate}
    properties:
      hibernate:
        format_sql: true
        cache:
          use_second_level_cache: false
          use_query_cache: false
  cache:
    type: ${SPRING_CACHE_TYPE:simple}
  flyway:
    # å¼€å‘ç¯å¢ƒä¹Ÿå¯ç”¨ Flyway è¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬ç®¡ç† ğŸ¯
    enabled: ${FLYWAY_ENABLED:true}
logging:
  level:
    org.redisson: WARN
app:
  redis:
    mode: ${APP_REDIS_MODE:redis}

---
spring:
  config:
    activate:
      on-profile: test
  datasource:
    url: jdbc:postgresql://${TEST_DB_HOST:${CI_DB_HOST:localhost}}:${TEST_DB_PORT:${CI_DB_PORT:5432}}/${TEST_DB_NAME:${CI_DB_NAME:campus_marketplace_test}}
    username: ${TEST_DB_USERNAME:${CI_DB_USERNAME:postgres}}
    password: ${TEST_DB_PASSWORD:${CI_DB_PASSWORD:123456}}
    driver-class-name: org.postgresql.Driver
    hikari:
      minimum-idle: ${TEST_DB_POOL_MIN_IDLE:5}
      maximum-pool-size: ${TEST_DB_POOL_MAX_SIZE:10}
      connection-timeout: ${TEST_DB_CONNECTION_TIMEOUT:20000}
  jpa:
    hibernate:
      ddl-auto: ${TEST_JPA_DDL_AUTO:validate}
    show-sql: ${TEST_JPA_SHOW_SQL:false}
  data:
    redis:
      host: ${TEST_REDIS_HOST:${CI_REDIS_HOST:localhost}}
      port: ${TEST_REDIS_PORT:${CI_REDIS_PORT:6379}}
      password: ${TEST_REDIS_PASSWORD:${CI_REDIS_PASSWORD:}}
      database: ${TEST_REDIS_DATABASE:0}
  task:
    scheduling:
      enabled: false
    execution:
      pool:
        core-size: ${TEST_EXECUTOR_CORE_SIZE:2}
      shutdown:
        await-termination: true
  main:
    banner-mode: "off"
  output:
    ansi:
      enabled: DETECT
  flyway:
    enabled: true
app:
  cache:
    prewarm:
      enabled: false
  redis:
    mode: ${APP_REDIS_MODE:redis}
  scheduling:
    privacy:
      enabled: false
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: false
server:
  port: ${TEST_SERVER_PORT:${SERVER_PORT:8080}}
management:
  endpoints:
    enabled-by-default: false  # âœ… BaSui: æµ‹è¯•ç¯å¢ƒç¦ç”¨æ‰€æœ‰ Actuator ç«¯ç‚¹
    web:
      exposure:
        include: none

---
spring:
  config:
    activate:
      on-profile: prod
  jpa:
    hibernate:
      ddl-auto: ${PROD_JPA_DDL_AUTO:validate}
    show-sql: ${PROD_JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: ${PROD_HIBERNATE_FORMAT_SQL:false}
        enable_lazy_load_no_trans: ${PROD_ENABLE_LAZY_NO_TRANS:false}
        jdbc:
          batch_size: ${PROD_JPA_BATCH_SIZE:100}
        cache:
          use_second_level_cache: ${PROD_SECOND_LEVEL_CACHE:true}
          use_query_cache: ${PROD_QUERY_CACHE:true}
  data:
    redis:
      sentinel:
        master: ${REDIS_SENTINEL_MASTER:}
        nodes: ${REDIS_SENTINEL_NODES:}
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      lettuce:
        pool:
          max-active: ${REDIS_POOL_MAX_ACTIVE:100}
          max-idle: ${REDIS_POOL_MAX_IDLE:50}
          min-idle: ${REDIS_POOL_MIN_IDLE:20}
          max-wait: 3000ms
      timeout: 3000ms
logging:
  level:
    root: ${LOG_LEVEL_ROOT:WARN}
    com.campus.marketplace: ${LOG_LEVEL_APP:INFO}
    org.hibernate.SQL: ${LOG_LEVEL_SQL:WARN}
    org.springframework.security: ${LOG_LEVEL_SPRING_SECURITY:WARN}
  file:
    name: ${LOG_FILE_PATH:/var/log/campus-marketplace/campus-marketplace.log}
    max-size: ${LOG_FILE_MAX_SIZE:50MB}
    max-history: ${LOG_FILE_MAX_HISTORY:60}
management:
  endpoints:
    web:
      exposure:
        include: ${ACTUATOR_ENDPOINTS:health,metrics,prometheus}
        exclude: ${ACTUATOR_EXCLUDE:shutdown,env,beans,configprops,threaddump,heapdump}
  endpoint:
    health:
      show-details: ${ACTUATOR_HEALTH_SHOW_DETAILS:never}
  metrics:
    export:
      prometheus:
        enabled: ${PROMETHEUS_ENABLED:true}
    distribution:
      percentiles-histogram:
        http.server.requests: ${METRICS_HTTP_HISTOGRAM:true}
    tags:
      environment: ${DEPLOY_ENV:prod}
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: ${APP_CONTEXT_PATH:/api}
  tomcat:
    threads:
      max: ${TOMCAT_MAX_THREADS:400}
      min-spare: ${TOMCAT_MIN_SPARE_THREADS:50}
    connection-timeout: ${TOMCAT_CONNECTION_TIMEOUT:20000}
    compression:
      enabled: true
      mime-types: text/html,text/xml,text/plain,text/css,application/json,application/javascript
      min-response-size: 1024
  ssl:
    enabled: ${SSL_ENABLED:false}
    key-store: ${SSL_KEY_STORE:}
    key-store-password: ${SSL_KEY_STORE_PASSWORD:}
    key-store-type: ${SSL_KEY_STORE_TYPE:PKCS12}
alipay:
  gateway-url: ${ALIPAY_GATEWAY_URL:https://openapi.alipay.com/gateway.do}
wechat:
  pay:
    version: ${WECHAT_PAY_VERSION:v3}
app:
  redis:
    mode: ${APP_REDIS_MODE:redis}

# çº çº·è¶…æ—¶æ£€æŸ¥é…ç½®
dispute:
  timeout:
    check:
      # åå•†è¶…æ—¶æ£€æŸ¥å®šæ—¶ä»»åŠ¡ Cron è¡¨è¾¾å¼ï¼ˆé»˜è®¤ï¼šæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
      # æ ¼å¼ï¼šç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
      # 0 0 */6 * * ? = æ¯å¤© 0ç‚¹ã€6ç‚¹ã€12ç‚¹ã€18ç‚¹ æ‰§è¡Œ
      negotiation:
        cron: ${DISPUTE_TIMEOUT_CHECK_NEGOTIATION_CRON:0 0 */6 * * ?}
      # ä»²è£è¶…æ—¶æ£€æŸ¥å®šæ—¶ä»»åŠ¡ Cron è¡¨è¾¾å¼ï¼ˆé»˜è®¤ï¼šæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
      arbitration:
        cron: ${DISPUTE_TIMEOUT_CHECK_ARBITRATION_CRON:0 0 */6 * * ?}

# ç‰©æµç³»ç»Ÿé…ç½®
logistics:
  # æ˜¯å¦å¯ç”¨æ¨¡æ‹Ÿç‰©æµAPIï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼‰
  mock:
    enabled: ${LOGISTICS_MOCK_ENABLED:true}
  # æ˜¯å¦å¯ç”¨å®šæ—¶ä»»åŠ¡
  scheduler:
    enabled: ${LOGISTICS_SCHEDULER_ENABLED:true}
