-- =====================================================
-- Flyway 数据库迁移脚本 V10 - 添加 2FA 恢复码字段
-- =====================================================
-- 作者: BaSui 😎
-- 日期: 2025-11-09
-- 描述: 为 t_user 表添加 2FA 恢复码字段，用于存储加密后的恢复码
-- 数据库: PostgreSQL 14+
-- =====================================================

-- =====================================================
-- 1. 添加 2FA 恢复码字段
-- =====================================================

-- 2FA 恢复码（JSON 数组，存储加密后的恢复码）
ALTER TABLE t_user ADD COLUMN IF NOT EXISTS two_factor_recovery_codes TEXT;

-- 2FA 启用时间
ALTER TABLE t_user ADD COLUMN IF NOT EXISTS two_factor_enabled_at TIMESTAMP;

-- =====================================================
-- 2. 添加注释说明
-- =====================================================

COMMENT ON COLUMN t_user.two_factor_recovery_codes IS '2FA 恢复码（JSON 数组，存储加密后的恢复码）';
COMMENT ON COLUMN t_user.two_factor_enabled_at IS '2FA 启用时间';

-- =====================================================
-- 3. 创建索引（可选，用于查询优化）
-- =====================================================

-- 为 two_factor_enabled 字段创建索引（用于快速查询启用 2FA 的用户）
CREATE INDEX IF NOT EXISTS idx_user_two_factor_enabled ON t_user(two_factor_enabled) WHERE two_factor_enabled = true;

-- =====================================================
-- 完成！🎉
-- =====================================================
--
-- 📝 说明：
-- 1. ✅ 添加 two_factor_recovery_codes 字段（TEXT 类型，存储 JSON 数组）
-- 2. ✅ 添加 two_factor_enabled_at 字段（记录启用时间）
-- 3. ✅ 创建索引优化查询性能
--
-- 🔐 安全说明：
-- - 恢复码必须加密存储（使用 BCrypt 或 AES）
-- - 恢复码一次性使用后需要标记为已使用或删除
-- - 建议生成 8-10 个恢复码，每个 8-16 位
--
-- 🚀 使用示例：
-- - 启用 2FA 时生成恢复码并加密存储
-- - 用户丢失 2FA 设备时使用恢复码登录
-- - 恢复码使用后立即失效
--
-- =====================================================
