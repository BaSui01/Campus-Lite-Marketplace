# 支付宝沙箱环境配置指南 💳

> **作者**: BaSui 😎
> **日期**: 2025-10-27
> **适用**: 校园轻享集市系统 - 支付功能

---

## 📋 你的沙箱配置信息

| 配置项 | 值 |
|-------|---|
| **APPID** | `9021000157621480` |
| **商家 PID** | `2088721085802942` |
| **网关地址** | `https://openapi-sandbox.dl.alipaydev.com/gateway.do` |
| **加签方式** | 公钥模式（已启用）|
| **商家账号** | fyxpyq5335@sandbox.com (密码: 111111) |
| **买家账号** | eoxjkn7569@sandbox.com (密码/支付密码: 111111) |

---

## 🚀 快速开始（3步搞定）

### 第 1 步：生成密钥对 🔑

1. **下载密钥生成工具**：
   https://opendocs.alipay.com/common/02khjo

2. **运行工具**，选择 **RSA2(SHA256) - 2048位**

3. **生成后会得到两个文件**：
   - `alipay_private_key.txt` ← 应用私钥（配置到 `.env`）
   - `alipay_public_key.txt` ← 应用公钥（上传到支付宝平台）

### 第 2 步：上传应用公钥 📤

1. 访问：https://open.alipay.com/develop/sandbox/app
2. 找到"接口加签方式(公钥模式)" → 点击"设置"
3. 粘贴 `alipay_public_key.txt` 的内容（**去掉** `-----BEGIN/END-----` 标记）
4. 保存后，支付宝会返回 **"支付宝公钥"**（记得复制！）

### 第 3 步：配置环境变量 ⚙️

编辑项目根目录的 `.env` 文件：

```bash
# 沙箱 APPID（开放平台应用详情页可见）
ALIPAY_APP_ID=9021000157621480

# 应用私钥（从 alipay_private_key.txt 复制，去掉 BEGIN/END）
ALIPAY_PRIVATE_KEY=MIIEvQIBADANBgkqhkiG9w0BAQEFAASC...（一长串）

# 支付宝公钥（开放平台返回，去掉 BEGIN/END）
ALIPAY_PUBLIC_KEY=MIIBIjANBgkqhkiG9w0BAQEFAAOCA...（一长串）

# 可选覆盖：沙箱网关与回调地址
ALIPAY_GATEWAY_URL=https://openapi-sandbox.dl.alipaydev.com/gateway.do
ALIPAY_NOTIFY_URL=http://localhost:8080/api/payment/alipay/notify
ALIPAY_RETURN_URL=http://localhost:3000/payment/result
```

**✅ 完成！启动应用即可测试支付！**

---

## 🧪 测试支付

### 1. 启动后端服务

```bash
cd backend
mvn spring-boot:run
```

### 2. 创建订单并支付

```bash
curl -X POST http://localhost:8080/api/orders \
  -H "Authorization: Bearer <STUDENT_OR_TEACHER_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "goodsId": 1
  }'
```

### 3. 使用买家账号登录支付

- 账号：`eoxjkn7569@sandbox.com`
- 登录密码：`111111`
- 支付密码：`111111`

---

## ❓ 常见问题

### Q1: 签名验证失败？

**原因**：
- 私钥/公钥配置错误
- 应用公钥未上传到支付宝平台

**解决**：
1. 确认 `ALIPAY_PRIVATE_KEY` 是**应用私钥**（不是支付宝公钥）
2. 确认 `ALIPAY_PUBLIC_KEY` 是**支付宝公钥**（不是应用公钥）
3. 确保应用公钥已上传到支付宝沙箱平台
4. 密钥内容去掉首尾的 `-----BEGIN/END-----` 标记

### Q2: 本地回调地址无法访问？

**原因**：
支付宝无法访问 `localhost`

**解决**：
使用内网穿透工具：
- **ngrok**: `ngrok http 8200`
- **natapp**: https://natapp.cn

然后更新 `.env` 中的回调地址：
```bash
ALIPAY_NOTIFY_URL=https://your-domain.ngrok.io/api/payment/alipay/notify
```

### Q3: 网关地址错误？

**确认**：
沙箱环境网关地址是 `https://openapi-sandbox.dl.alipaydev.com/gateway.do`
（不是 `https://openapi.alipaydev.com/gateway.do`）

---

## 📚 参考资源

- **支付宝开放平台**: https://open.alipay.com
- **沙箱环境**: https://open.alipay.com/develop/sandbox/app
- **密钥生成工具**: https://opendocs.alipay.com/common/02khjo
- **内网穿透 (ngrok)**: https://ngrok.com
- **内网穿透 (natapp)**: https://natapp.cn

---

**🎉 配置完成！祝你测试顺利！有问题随时找我 BaSui！** 😎✨
