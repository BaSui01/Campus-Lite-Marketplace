# 共享层重构计划（方案 B）

## 1. 背景与目标
- **现状痛点**：共享层同时存在手写 `services` 与 OpenAPI 生成客户端，`../utils/http` 缺失导致不可用；手工类型与自动生成模型重复、字段不一致；业务侧分散实例化 `DefaultApi`，Token 注入与错误处理不统一。
- **改造目标**：完全依赖自动生成的 `DefaultApi` 与模型，移除手写服务、重复类型和失效工具，统一通过 `getApi()` / `createApi()` 使用后端接口；确保 Token 管理、错误处理集中在 `apiClient`，并由环境变量统一控制 API 根路径与前端开发端口。

## 2. 范围界定
- **纳入范围**
  - `frontend/packages/shared/src/services/*` 及相关导出。
  - `frontend/packages/shared/src/types` 中与 OpenAPI 模型重复的定义。
  - 依赖共享层服务的 Portal/Admin 业务代码。
  - 构建脚本、文档、ci 任务中关于共享层的说明。
- **不纳入范围**
  - 后端 OpenAPI 定义（若缺失接口需另开任务补充）。
  - UI 组件、样式、非 API 相关工具函数。

## 3. 工作分解
| 阶段 | 主要任务 | 产出 | 负责人 |
| --- | --- | --- | --- |
| 0. 准备 | 梳理 API 覆盖度、确认后端 OpenAPI 定义覆盖率 100%；冻结共享层手写服务的新增改动；梳理根目录 `.env` 及子项目 `.env.*` 中的 `VITE_API_BASE_URL`、端口配置 | 改造确认邮件/issue、环境变量清单 | 架构负责人 |
| 1. 客户端统一 | 扩展 `utils/apiClient.ts`：提供 `getApi`、`createApi`、Token 管理、错误处理；从环境变量读取 API 根路径；更新文档 | 新版 `apiClient`、环境变量约定说明 | 平台组 |
| 2. 移除服务层 | 分批下线 `services` 目录的手写模块：优先迁移通知/WebSocket 至 `utils/websocket.ts`，其余服务改造为 `getApi()` 薄封装并逐步替换业务代码 | PR 集合（去除旧模块依赖） | 各前端团队 |
| 3. 类型收敛 | 用 `@campus/shared/api/models` 替换手写实体；仅保留前端扩展类型；补充必要的 UI 辅助类型 | 类型清单 & lint 通过 | 平台组 |
| 4. 测试验证 | 跑通核心流程（登录、通知、订单、上传）；新增冒烟脚本或自动化测试 | 验收报告、测试用例 | 测试/开发联合 |
| 5. 文档与脚本 | 更新 README、CLI 提示、`api:generate` 使用说明；清理冗余脚本 | 文档更新 PR | 平台组 |
| 6. 发布与回顾 | 合并主干、发版；收集反馈、沉淀经验 | 发布公告、回顾会议记录 | 架构负责人 |

## 4. 里程碑与时间安排（建议）
| 日期 | 里程碑 |
| --- | --- |
| T+0 | 完成准备阶段，确认 OpenAPI 覆盖情况及 `.env` 中的 API 根路径/端口配置 |
| T+3 | 客户端统一改造合入主干 |
| T+7 | 所有业务端完成迁移、旧服务目录删除 |
| T+10 | 类型收敛与测试通过 |
| T+12 | 文档/脚本更新完成，准备发版 |
| T+14 | 发布上线并完成回顾 |

> 时间可根据团队人力调整，建议按周同步进展。

## 5. 验收标准
- `frontend/packages/shared` 不再包含 `services` 目录及旧类型定义。
- 所有前端项目对后端接口的调用均通过 `getApi()` 或 `createApi()`。
- `pnpm --filter @campus/shared build` 与各应用 `type-check` 全部通过。
- 核心业务流程线下、线上环境均验证通过（含 Token 过期自动刷新）。
- 根目录 `.env` 与子项目 `.env.*` 中的 `VITE_API_BASE_URL`、端口配置统一生效，`apiClient` 能正确读取。
- 相关文档、脚本、CI 任务已更新。

## 6. 风险与缓解措施
| 风险 | 影响 | 缓解策略 |
| --- | --- | --- |
| OpenAPI 定义缺失或字段不匹配 | 迁移后运行时报错 | 迁移前跑通 `api:generate` 并与后端确认；建立回滚策略 |
| 业务代码遗漏更新 | 编译或运行失败 | 代码扫描，CI 增加 `grep shared/services` 校验；全局搜替换 |
| Token 刷新逻辑变更引发登录问题 | 用户无法长时登录 | 在 `apiClient` 保留原刷新逻辑并加单测 |
| 环境变量配置不一致 | 不同环境请求错误地址或端口冲突 | 统一维护根目录 `.env` 与子项目 `.env.*`，在流水线新增环境校验脚本 |
| 团队认知滞后 | 新接口仍被手写服务包装 | 宣贯会议 + Code Review 检查清单 |

## 7. 沟通与协作
- **沟通渠道**：钉钉群「前端平台组」、Weekly 架构例会、PR Review。
- **跟踪方式**：在项目管理工具中建立「共享层统一」Epic，所有任务纳入同一看板。
- **回滚策略**：保留旧服务分支快照，必要时可快速切回；生产问题优先通过 Feature Flag 封禁受影响模块。

## 8. 后续展望
- 评估 OpenAPI 自定义模板（Template Override）以生成更贴合前端的 SDK。
- 结合 `getApi()` 增加请求追踪、性能监控埋点。
- 打通端到端契约测试，保证后端接口变更第一时间触达前端。
