# 共享层架构设计说明

## 1. 模块定位
- **包名**：`@campus/shared`
- **职责**：为 Portal / Admin 提供统一的 API 客户端、类型模型、UI 组件、通用 Hook 与工具方法。
- **设计原则**：单一数据源（OpenAPI），按功能分层（API / Components / Hooks / Utils），保持无状态、可复用、可单独构建发布。

## 2. 技术栈与构建
- **语言**：TypeScript + React 18。
- **构建工具**：`tsup`（ESM+CJS+DTS），配置见 `tsup.config.ts`。
- **代码生成**：`openapi-generator-maven-plugin` 输出 TypeScript Axios SDK。
- **打包出口**：`package.json` `exports` 字段分别导出 `.`、`./api`、`./components`、`./utils`。

## 3. 目录概览
```
frontend/packages/shared/
├─ src/
│  ├─ api/              # OpenAPI 生成代码
│  ├─ components/       # 公共 UI 组件
│  ├─ constants/        # 常量配置、枚举
│  ├─ hooks/            # React 通用 Hook
│  ├─ services/         # 手写服务（待迁移移除）
│  ├─ types/            # 手写类型（待与模型合并）
│  ├─ utils/            # 工具函数、API 客户端
│  ├─ ComponentTest.tsx # 组件演示入口
│  └─ index.ts          # 包入口
├─ package.json
├─ tsconfig.json
└─ tsup.config.ts
```

> `services`、`types` 目录将在方案 B 重构中移除，此处依旧列出便于历史兼容。

## 4. 核心流程
1. **API 使用链路**：业务代码 → `@campus/shared/utils` 导出的 `getApi()` → OpenAPI 生成的 `DefaultApi` → Axios 请求 → 后端服务。
2. **组件导入链路**：业务代码按需从 `@campus/shared/components` 引用 UI 组件。
3. **类型共享链路**：业务代码从 `@campus/shared/api/models` 获取契约类型，或从 `@campus/shared/types` 获取前端特有类型。
4. **构建发布**：运行 `pnpm --filter @campus/shared build`，`tsup` 根据 `tsup.config.ts` 生成 `dist` 目录。

## 5. 文件职责明细

### 5.1 根目录
| 文件 | 说明 |
| --- | --- |
| `package.json` | 包元数据，定义构建脚本、导出、依赖与 `peerDependencies`。 |
| `tsconfig.json` | TypeScript 编译配置，开启严格模式、生成声明文件。 |
| `tsup.config.ts` | `tsup` 构建配置，指定多入口打包、treeshake、sourcemap。 |

### 5.2 `src/index.ts`
- 作用：集中导出共享层的 API、组件、工具、类型、常量、Hooks、Services（重构后去除 Services）。
- 依赖：通过通配符转发至各子目录。

### 5.3 `src/ComponentTest.tsx`
- 作用：用于本地调试组件的测试页示例（非生产导出）。
- 内容：演示调用组件库，方便在 Storybook 前的快速验证。

### 5.4 `src/api`（OpenAPI 自动生成）
- `api.ts` / `base.ts` / `common.ts` / `configuration.ts`：自动生成的请求封装、基础类型与配置模块。
- `index.ts`：统一 re-export。
- `.gitignore` / `.npmignore` / `.openapi-generator-ignore`：生成器的排除规则。
- `api/default-api.ts`：`DefaultApi` 类，封装全部 REST 接口。
- `models/*.ts`：每个后端数据模型对应的 TypeScript 接口（数量众多，命名与后端实体一致）。
- `git_push.sh`：生成器默认脚本（未使用，待清理）。

> 这些文件禁止手动修改，如需调整需更新 OpenAPI 模板或重新生成。

### 5.5 `src/components`
- **目录说明**：每个组件使用独立文件夹，包含 `*.tsx` + `*.css` + `index.ts`。
- **组件清单**：
  - `Avatar/`：头像组件，封装用户头像展示与尺寸样式。
  - `Badge/`：徽标组件，用于状态角标显示。
  - `Button/`：按钮组件，支持多种主题、尺寸。
  - `Card/`：基础卡片容器，统一阴影及边距。
  - `Dropdown/`：下拉菜单组件，封装触发与菜单项逻辑。
  - `Form/`：表单容器，包含表单项布局与校验样式。
  - `GoodsCard/`：商品卡片，展示商品标题、价格、指标。
  - `ImageUpload/`：图片上传控件，支持拖拽与预览。
  - `Input/`：输入框组件，封装状态样式、错误提示。
  - `Loading/`：通用加载动画。
  - `Modal/`：模态对话框，提供开关与动画。
  - `OrderCard/`：订单信息卡片。
  - `Pagination/`：分页器。
  - `RichTextEditor/`：富文本编辑器封装。
  - `Skeleton/`：骨架屏。
  - `Table/`：表格组件。
  - `Tabs/`：选项卡组件。
  - `Tag/`：标签组件。
  - `Toast/`：轻提示组件。
  - `UserAvatar/`：带状态的用户头像。
  - `index.ts`：集中导出所有组件。

> 每个组件 `index.ts` 通常导出主组件与类型定义，CSS 文件负责主题样式。

### 5.6 `src/constants`
- `config.ts`：系统配置常量（如接口基础路径、默认分页等）。
- `enum.ts`：共享枚举定义，供 UI 层使用。
- `status.ts`：状态码、流程状态映射。
- `index.ts`：集中导出常量模块。

### 5.7 `src/hooks`
- `index.ts`：导出所有 Hook。
- `useAuth.ts`：封装登录状态、用户信息管理。
- `useAuthGuard.ts`：路由守卫 Hook，处理未登录跳转。
- `useChatMessage.ts`：聊天消息订阅、状态管理。
- `useDebounce.ts`：函数防抖。
- `useForm.ts`：轻量表单管理（状态、校验）。
- `useLocalStorage.ts`：本地存储读写。
- `useNotification.ts`：通知状态与 Toast 交互。
- `useOrderUpdate.ts`：实时订单状态监听。
- `usePagination.ts`：分页状态管理与查询参数生成。
- `useRequest.ts`：通用请求 Hook，处理 loading/error。
- `useThrottle.ts`：函数节流。
- `useUpload.ts`：文件/图片上传状态管理。
- `useWebSocket.ts`：底层 WebSocket 连接 Hook。
- `useWebSocketService.ts`：基于业务事件的 WebSocket 封装。

### 5.8 `src/services`（逐步替换中）
- `auth.ts`、`goods.ts`、`order.ts`、`message.ts`、`post.ts`、`refund.ts`、`upload.ts`、`user.ts`：历史遗留的薄包装，重构中逐步改造为基于 `getApi()` 的类型安全调用。
- `notification.ts`、`websocket.ts`、`WebSocketClient.ts`：已在本轮重构中下线，相关能力迁移至 `utils/websocket.ts`。
- `index.ts`：仅做命名导出（不再暴露 `services` 聚合对象）。

> 该目录将在全部迁移完成后清理，新的入口均来自 `utils`。

### 5.9 `src/types`（待收敛）
- `api.ts`：手写 API 响应与请求类型。
- `common.ts`：分页、表单等通用类型。
- `entity.ts`：业务实体（User/Goods/Order 等）。
- `enum.ts`：枚举类型。
- `index.ts`：导出所有类型。

> 重构中将优先使用 `api/models` 下的自动生成类型，仅保留前端独有结构。

### 5.10 `src/utils`
- `apiClient.ts`：Axios 实例、Token 管理、`getApi()`/`resetApiInstance()` 等核心封装。
- `format.ts`：格式化工具（时间、货币等）。
- `highlight.ts`：文本高亮工具。
- `websocket.ts`：WebSocket 客户端与服务封装（替代原 services 目录），提供 `websocketService`、`WebSocketClient` 等。
- `index.ts`：导出所有工具函数。
- `storage.ts`：本地存储读写封装。
- `validator.ts`：前端校验函数。

### 5.11 其他
- `src/nul`：Windows 复制遗留文件，内容为 `index.ts`，应清理。

## 6. 依赖关系
- `components`、`hooks`、`utils` 可单独被业务引用，互不强耦合。
- `hooks` 通常依赖 `utils/apiClient.ts` 或 WebSocket 客户端。
- `services`（待移除）依赖 `utils/apiClient` 与 `types`。
- `types` 与 `constants` 被组件、hooks、业务共享。

## 7. 约定与最佳实践
- **API 调用**：统一通过 `getApi()` 获取 `DefaultApi`，禁止新建手写服务。
- **类型管理**：优先引用 `@campus/shared/api/models`；若需扩展类型，放在 `types` 并注明用途。
- **组件规范**：每个组件目录保留 `index.ts` 作为导出入口，CSS 采用 BEM 或约定前缀。
- **Hook 规范**：Hook 名称以 `use` 开头，文档注明依赖（如是否需要 WebSocket 连接）。
- **构建**：修改公共模块后执行 `pnpm --filter @campus/shared build && pnpm --filter @campus/shared type-check`。

## 8. 重构指引（方案 B）
- 删除 `services`、`types` 中的冗余文件前先完成业务迁移与类型替换。
- `apiClient.ts` 将成为 API 接入唯一入口，可在此添加统一拦截器、监控埋点。
- 文档、CLI 需同步更新，提醒开发者直接使用 `getApi()` 和自动生成模型。

## 9. 附录：未来演进方向
- **OpenAPI 模板定制**：生成更加贴合需求的 SDK，包括错误统一封装、数据自动解包。
- **契约测试**：接入后端契约测试，保证 `api:generate` 产物的稳定性。
- **包发布**：视需求将 `@campus/shared` 发布到内部 npm registry，以便跨项目复用。
