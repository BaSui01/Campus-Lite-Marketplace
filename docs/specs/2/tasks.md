# 校园轻享集市系统 - Spec #2 实现任务列表（53-68）

说明：以下任务按模块拆分并标注需求编号。标记含义：[ ] 未开始 / [-] 进行中 / [x] 已完成。

---

## 阶段一：多校区与全文检索

### [x] T1 多校区落地（需求 53）
- [x] 新增表 t_campus 与默认数据，核心表补充 campus_id 字段与索引（DDL + 回填脚本）
- [x] 鉴权与查询强制 campus 限制（请求过滤器 + Service 校验，先覆盖 Goods/Post）
- [x] 扩展到 Order/Favorite/Message 的校区校验
- [x] Campus 管理接口（CRUD、启停用、用户迁移校验）
- [x] 单元测试：Order 跨校下单/查询权限
- [x] 单元测试：Favorite 跨校收藏、Message 跨校通信
- [x] 集成测试：跨校隔离、管理员跨校操作、索引命中
- [x] 集成测试（Testcontainers）：GoodsRepository 校区过滤 IT

### [x] T2 PostgreSQL FTS（需求 54）
- [x] 为 Goods/Post 增加 tsvector 列与触发器、GIN 索引（中文分词配置）
- [x] SearchService 与 /api/search 接口（高亮、rank 排序、分页与校区过滤）
- [x] 记录搜索日志（耗时、命中数、关键词）
- [x] 集成测试：高亮片段、排序正确性、空查询 400

---

## 阶段二：推荐榜单与订单后处理

### [x] T3 推荐与榜单（需求 55）
- [x] 评分模型与计算任务（分布式锁），结果写入 Redis: goods:rank:{campus}
- [x] 个性化推荐（基于最近浏览/收藏类目/标签），无历史回退热榜
- [x] 接口：/api/recommend/hot 与 /api/recommend/personal，缓存 TTL 与降级策略
- [x] 压测与集成测试：缓存命中 P95、降级回退

### [x] T4 售后与退款（需求 56）
- [x] 表 t_refund_request、t_payment_log 与状态机实现，审计与幂等键
- [x] 渠道退款对接与回调处理、失败重试与告警（支付宝退款/回调/重试/对账完成）
- [x] 对账任务：按日生成差异报告
- [x] 测试：状态迁移、渠道失败路径，回调幂等/对账

### [x] T5 订单取消与超时（需求 57）
- [x] 买家/卖家取消接口与规则校验、优惠券回退
- [x] 自动关闭超时未支付订单（定时任务，幂等）
- [x] 通知与审计日志
- [x] 集成测试：并发取消与幂等验证

---

## 阶段三：通知、合规、限流

### [-] T6 通知渠道扩展（需求 58）
- [x] 模板与用户偏好表/接口，i18n 渲染（模板渲染服务+偏好/退订API+i18n）
- [x] 邮件与 WebPush 发送器（异步+限速+队列批量消费+失败重试）
- [x] 事件接入（订单、帖子、@ 提及）与退订逻辑（统一分发/入队）
- [ ] 测试：偏好生效、退订、速率限制

### [-] T7 内容合规模块（需求 59）
- [x] 文本 DFA 中台化封装，策略配置与命中动作（ComplianceService）
- [x] 图片扫描 SPI 接口与环境开关（Noop 实现，配置开关）
- [x] 审计日志与灰度白名单（审计表/白名单表+管理接口）
- [ ] 测试：命中/误报场景、降级与人工审核队列

### [-] T8 限流与反滥用（需求 60）
- [-] 注解 + AOP + Redis 滑动窗口/令牌桶实现（已完成：滑动窗口；待做：令牌桶）
- [x] 规则管理接口与动态刷新，黑白名单（内存实现，可扩展持久化）
- [x] 429 标准响应与 RateLimit-* 头
- [ ] 压测与测试：规则命中、白名单豁免

---

## 阶段四：导出、任务、开关、i18n、可观测

### [x] T9 数据导出与报表（需求 61）
- [x] 异步导出任务与分页流式写出，临时文件与签名下载（CSV）
- [x] 权限与校区隔离校验、阈值限制（200k 行）
- [x] 任务查询/取消/清理接口，审计日志
- [-] 集成测试：已覆盖下载有效期/权限/触发；大数据量与阈值 IT 待补

### [x] T10 统一任务框架（需求 62）
- [x] 任务注册/记录/指标，Redis 分布式锁
- [x] 手动触发/暂停/参数化运行
- [x] 内置任务：热榜刷新/订单超时/对账/清理导出
- [-] 测试：已覆盖成功路径与分布式锁；并发与失败重试待补

### [x] T11 Feature Flags（需求 63）
- [x] 开关实体与评估器（env/user/campus），本地缓存+动态刷新
- [x] 管理接口与审计；关键路径接入与默认关闭
- [x] 测试：评估优先级与回退、缓存失效

### [x] T12 国际化 i18n（需求 64）
- [x] MessageSource 与资源文件、Accept-Language 解析
- [-] 错误码与通知模板 i18n 化（已完成错误码；模板待接）
- [x] 测试：多语言快照比对与回退

### [x] T13 可观测与指标（需求 65）
- [x] 日志 JSON 化与 MDC(traceId,userId,campusId) 透传
- [x] 关键指标埋点与 /actuator/prometheus 暴露
- [-] 测试：已覆盖 trace 头透传；指标标签正确性待补

---

## 阶段五：分类标签与关注订阅、隐私合规

### [x] T14 分类与标签（需求 67）
- [x] 标签表与绑定关系，类目树管理接口
- [x] 检索与搜索支持标签筛选，索引与上限校验
- [x] 测试：标签去重/合并、性能验证

### [x] T15 关注与订阅（需求 68）
- [x] 关注卖家与关键词订阅模型/接口
- [x] 触发通知（尊重偏好/退订/频控去重）
- [x] 测试：去重、频控、冷启动推荐

### [x] T16 数据隐私与合规（需求 66）
- [x] 数据导出与注销流程（强校验与延迟删除）
- [x] 数据最小化策略与定期清理任务
- [x] 测试：导出正确性、删除后访问行为

---

## 交付与质量门槛

- 覆盖率：新增模块单元+集成测试总体覆盖率 ≥ 85%
- 性能：搜索与推荐接口 P95 < 300ms（缓存命中 < 100ms）
- 安全：幂等/权限/限流/审计就绪；敏感信息脱敏
- 回滚：关键开关均受 Feature Flag 控制，默认关闭可安全回退
