# Spec 12: 前端敏感数据加密传输

> **功能**: 前端密码加密传输安全增强  
> **作者**: BaSui 😎  
> **日期**: 2025-11-06  
> **状态**: 待开发

---

## 📋 目录

- [需求背景](#需求背景)
- [用户故事](#用户故事)
- [功能需求](#功能需求)
- [非功能需求](#非功能需求)
- [验收标准](#验收标准)
- [业务规则](#业务规则)

---

## 🎯 需求背景

### 当前问题

**安全隐患**：
- ❌ **明文传输**：前端直接发送明文密码到后端
- ❌ **抓包可见**：中间人攻击可获取用户密码
- ❌ **日志泄露**：前端控制台可能记录明文密码
- ❌ **不符合规范**：违反安全最佳实践（OWASP Top 10）

**影响范围**：
- 登录接口：`POST /api/auth/login`
- 注册接口：`POST /api/auth/register`
- 修改密码接口：`POST /api/auth/change-password`
- 重置密码接口：`POST /api/auth/reset-password`

### 技术背景

**现状**：
- ✅ 后端使用 BCrypt 加密存储密码
- ✅ 生产环境使用 HTTPS（传输层加密）
- ❌ 前端未对密码进行加密（明文可见）

**业界标准**：
1. **传输层加密**：HTTPS（必须）
2. **应用层加密**：前端加密（推荐）
3. **存储层加密**：BCrypt/Argon2（必须）

---

## 👥 用户故事

### 故事1：用户登录时密码被加密传输

**作为** 系统用户  
**我希望** 我的密码在传输过程中被加密  
**以便** 即使传输过程被拦截，攻击者也无法获取我的明文密码

**验收标准**：
- ✅ 用户输入密码后，前端自动加密
- ✅ 网络抓包只能看到密文
- ✅ 浏览器控制台不显示明文密码
- ✅ 登录成功率不受影响

### 故事2：用户注册时密码被加密传输

**作为** 新用户  
**我希望** 注册时输入的密码被加密传输  
**以便** 我的密码从一开始就受到保护

**验收标准**：
- ✅ 注册表单提交时自动加密密码
- ✅ 网络请求中只包含密文
- ✅ 注册成功后可以正常登录

### 故事3：开发者无法看到明文密码

**作为** 开发者  
**我希望** 即使在开发环境也看不到用户明文密码  
**以便** 养成良好的安全习惯，避免生产环境泄露

**验收标准**：
- ✅ 浏览器DevTools中不显示明文
- ✅ 日志中不记录明文密码
- ✅ 错误信息不包含密码

---

## 📝 功能需求

### FR1: 前端密码加密

**需求描述**：  
前端在提交密码前，使用加密算法对密码进行加密。

**功能点**：
1. **加密算法选择**：
   - **方案A**：AES对称加密（性能好，需要密钥管理）
   - **方案B**：RSA非对称加密（安全性高，性能较低）
   - **推荐**：AES-256-CBC（前端使用固定密钥，后端验证）

2. **加密时机**：
   - 用户点击登录/注册按钮时
   - 表单验证通过后
   - 发送HTTP请求之前

3. **加密范围**：
   - 登录密码
   - 注册密码
   - 修改密码（旧密码 + 新密码）
   - 重置密码

### FR2: 后端密码解密

**需求描述**：  
后端接收加密密码后，先解密再进行BCrypt验证。

**功能点**：
1. **解密逻辑**：
   - 接收前端加密密码
   - 使用相同密钥解密
   - 解密后进行BCrypt验证

2. **异常处理**：
   - 解密失败 → 返回 "密码格式错误"
   - 密钥不匹配 → 返回 "系统配置错误"
   - 空密码 → 返回 "密码不能为空"

3. **兼容性**：
   - 支持旧客户端明文密码（逐步废弃）
   - 通过请求头识别加密类型

### FR3: 密钥管理

**需求描述**：  
前端和后端使用统一的加密密钥，确保加密解密一致。

**功能点**：
1. **密钥配置**：
   - 前端：环境变量 `VITE_ENCRYPT_KEY`
   - 后端：配置文件 `app.security.encrypt-key`

2. **密钥轮换**：
   - 支持多密钥（新旧兼容）
   - 定期更换密钥（建议每季度）

3. **密钥安全**：
   - 不提交到Git仓库
   - 使用环境变量或密钥管理服务

---

## ⚡ 非功能需求

### NFR1: 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| **加密耗时** | <10ms | 前端加密不影响用户体验 |
| **解密耗时** | <5ms | 后端解密快速响应 |
| **登录性能** | 无影响 | 与明文传输相比无性能损失 |

### NFR2: 安全要求

| 要求 | 说明 |
|------|------|
| **算法强度** | AES-256或RSA-2048 |
| **密钥长度** | ≥32字节（256位） |
| **防重放攻击** | 可选：添加时间戳 + nonce |
| **密钥泄露保护** | 密钥不硬编码，使用环境变量 |

### NFR3: 兼容性要求

| 要求 | 说明 |
|------|------|
| **浏览器支持** | Chrome、Firefox、Safari、Edge最新版 |
| **移动端支持** | iOS Safari、Android Chrome |
| **后端兼容** | 支持旧客户端明文密码（过渡期） |

---

## ✅ 验收标准

### AC1: 登录密码加密

**Given** 用户在登录页面输入密码 `admin123`  
**When** 点击登录按钮  
**Then**：
- ✅ 网络请求中密码字段为密文（如：`U2FsdGVkX1...`）
- ✅ 浏览器DevTools不显示明文 `admin123`
- ✅ 后端成功解密并验证密码
- ✅ 登录成功返回JWT Token

### AC2: 注册密码加密

**Given** 新用户在注册页面输入密码 `newUser123`  
**When** 提交注册表单  
**Then**：
- ✅ 网络请求中密码字段为密文
- ✅ 后端解密后存储BCrypt哈希
- ✅ 注册成功后可以使用密码登录

### AC3: 修改密码加密

**Given** 用户在修改密码页面输入旧密码和新密码  
**When** 提交修改  
**Then**：
- ✅ 旧密码和新密码均为密文
- ✅ 后端解密验证旧密码正确
- ✅ 新密码解密后更新BCrypt哈希

### AC4: 异常处理

**Given** 前端发送错误的密文（密钥不匹配）  
**When** 后端尝试解密  
**Then**：
- ✅ 返回 400 Bad Request
- ✅ 错误信息：`密码格式错误，请重试`
- ✅ 日志记录解密失败（不记录密码内容）

### AC5: 性能验证

**Given** 1000个并发登录请求  
**When** 执行性能测试  
**Then**：
- ✅ P95响应时间 < 200ms（与明文相比增长<5%）
- ✅ 前端加密耗时 < 10ms
- ✅ 后端解密耗时 < 5ms

---

## 🔒 业务规则

### BR1: 加密算法规则

1. **使用AES-256-CBC算法**：
   - 密钥长度：32字节（256位）
   - IV（初始化向量）：16字节随机生成
   - 填充模式：PKCS7

2. **加密流程**：
   ```
   明文密码 → UTF-8编码 → AES-256-CBC加密 → Base64编码 → 发送
   ```

3. **解密流程**：
   ```
   接收 → Base64解码 → AES-256-CBC解密 → UTF-8解码 → 明文密码
   ```

### BR2: 密钥管理规则

1. **开发环境**：
   - 前端：`.env.development` 中配置
   - 后端：`application-dev.yml` 中配置
   - 密钥可以相对简单（用于测试）

2. **生产环境**：
   - 使用环境变量或密钥管理服务
   - 密钥必须强随机生成
   - 前后端密钥必须一致

3. **密钥轮换**：
   - 每季度更换一次
   - 支持多密钥并存（新旧兼容）
   - 旧密钥保留1个月后废弃

### BR3: 安全日志规则

1. **禁止记录**：
   - ❌ 明文密码
   - ❌ 密文密码
   - ❌ 加密密钥

2. **允许记录**：
   - ✅ 用户名
   - ✅ 登录时间
   - ✅ IP地址
   - ✅ 登录成功/失败状态
   - ✅ 解密失败次数（不包含密码内容）

3. **敏感信息脱敏**：
   - 密码字段：`password: ******`
   - 密钥字段：`key: [REDACTED]`

---

## 🚀 实施计划

### 阶段1：前端加密（第1-2天）

1. 安装 `crypto-js` 加密库
2. 实现加密工具函数
3. 修改登录/注册页面集成加密
4. 前端单元测试

### 阶段2：后端解密（第3-4天）

1. 实现解密工具类
2. 修改 AuthService 集成解密
3. 异常处理和日志
4. 后端单元测试

### 阶段3：集成测试（第5天）

1. 端到端测试
2. 性能测试
3. 安全测试（防重放攻击）
4. 兼容性测试

---

## 📚 参考文档

- [OWASP Top 10 - A02 Cryptographic Failures](https://owasp.org/Top10/A02_2021-Cryptographic_Failures/)
- [crypto-js 文档](https://www.npmjs.com/package/crypto-js)
- [AES加密标准](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)
- [项目安全规范](../tech.md#安全标准)

---

**维护者**: BaSui 😎  
**最后更新**: 2025-11-06
