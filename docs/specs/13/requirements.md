# Spec 13: 通知偏好设置 - 需求文档

> **功能**: 通知偏好设置  
> **作者**: BaSui 😎  
> **日期**: 2025-11-06  
> **优先级**: P2 → P1（用户体验提升）  
> **预计工时**: 2-3天

---

## 📋 功能概述

为用户提供**个性化通知设置**功能，允许用户自主控制：
- 📧 通知渠道开关（邮件/短信/站内信）
- 🌙 免打扰时段设置
- 🔕 退订/重新订阅特定通知
- 📊 查看当前通知偏好状态

**目标**：提升用户体验，减少通知骚扰，增强用户控制感。

---

## 🎯 用户故事

### 故事1：开关通知渠道
**作为** 用户  
**我想要** 关闭邮件通知，只保留站内信  
**这样** 我不会被邮件打扰，但仍能在平台内收到消息

**验收标准**：
- ✅ 可以独立开关每个渠道（EMAIL/SMS/IN_APP）
- ✅ 关闭后该渠道不再发送通知
- ✅ 设置立即生效

---

### 故事2：设置免打扰时段
**作为** 用户  
**我想要** 在晚上10点到早上8点不接收通知  
**这样** 我的休息不会被打扰

**验收标准**：
- ✅ 可以设置开始/结束时间（小时:分钟）
- ✅ 免打扰期间不发送任何通知（除紧急通知）
- ✅ 可以关闭免打扰功能

---

### 故事3：退订特定通知
**作为** 用户  
**我想要** 退订价格降价提醒，但保留订单通知  
**这样** 我只收到我关心的通知

**验收标准**：
- ✅ 可以查看所有通知类型列表
- ✅ 可以单独退订/重新订阅每种通知
- ✅ 退订后不再收到该类型通知

---

### 故事4：查看当前设置
**作为** 用户  
**我想要** 查看我当前的通知偏好设置  
**这样** 我知道哪些通知已开启/关闭

**验收标准**：
- ✅ 展示所有渠道的开关状态
- ✅ 展示免打扰时段（如果已设置）
- ✅ 展示已退订的通知类型

---

## 🔧 功能需求

### 1. 通知渠道管理

**渠道类型**：
- 📧 **EMAIL** - 邮件通知
- 📱 **SMS** - 短信通知（可选）
- 💬 **IN_APP** - 站内信通知

**操作**：
- 开启/关闭渠道
- 查询渠道状态

**业务规则**：
- 至少保留一个渠道开启（防止完全失联）
- IN_APP 渠道不可关闭（系统消息保底）

---

### 2. 免打扰时段

**设置项**：
- 开始时间（HH:MM）
- 结束时间（HH:MM）
- 启用/禁用开关

**业务规则**：
- 时间格式：24小时制
- 支持跨天（例如：22:00 - 08:00）
- 免打扰期间不发送通知（队列延迟至结束时间）
- 紧急通知（订单取消、支付失败）不受影响

---

### 3. 通知类型订阅

**通知类型**：
- 🛒 **ORDER** - 订单通知（不可退订）
- 💰 **PAYMENT** - 支付通知（不可退订）
- 💬 **MESSAGE** - 站内消息
- 👍 **LIKE** - 点赞通知
- 💬 **COMMENT** - 评论通知
- 👤 **FOLLOW** - 关注通知
- 💲 **PRICE_ALERT** - 价格提醒
- 📢 **SYSTEM** - 系统公告（不可退订）

**操作**：
- 退订通知类型
- 重新订阅通知类型
- 查询订阅状态

**业务规则**：
- 核心通知（ORDER/PAYMENT/SYSTEM）不可退订
- 退订后该类型通知不再发送
- 可以随时重新订阅

---

### 4. 偏好状态查询

**返回信息**：
- 各渠道开关状态
- 免打扰时段配置
- 已退订的通知类型列表

---

## 📊 数据模型（前端）

### NotificationPreference（通知偏好）

```typescript
interface NotificationPreference {
  userId: number;                    // 用户ID
  channels: {
    email: boolean;                  // 邮件开关
    sms: boolean;                    // 短信开关
    inApp: boolean;                  // 站内信开关（固定为true）
  };
  quietHours?: {
    enabled: boolean;                // 是否启用
    startTime: string;               // 开始时间 "22:00"
    endTime: string;                 // 结束时间 "08:00"
  };
  unsubscribedTypes: string[];       // 已退订的通知类型
  updatedAt: string;                 // 最后更新时间
}
```

---

## 🎨 UI/UX 设计

### 页面1：通知设置主页

**路径**：`/settings/notifications`

**布局**：
```
┌─────────────────────────────────────┐
│ 🔔 通知设置                          │
├─────────────────────────────────────┤
│                                      │
│ 📧 通知渠道                          │
│ ├─ [ ✓ ] 邮件通知                   │
│ ├─ [ ✗ ] 短信通知                   │
│ └─ [ ✓ ] 站内信 (不可关闭)         │
│                                      │
│ 🌙 免打扰时段                        │
│ ├─ [ ✓ ] 启用免打扰                 │
│ ├─ 开始: [22:00] ▼                 │
│ └─ 结束: [08:00] ▼                 │
│                                      │
│ 🔕 通知类型管理                      │
│ └─ [查看详情] →                     │
│                                      │
│ [保存设置]                          │
└─────────────────────────────────────┘
```

---

### 页面2：通知类型管理

**路径**：`/settings/notifications/types`

**布局**：
```
┌─────────────────────────────────────┐
│ 🔕 通知类型订阅                      │
├─────────────────────────────────────┤
│                                      │
│ ✓ 🛒 订单通知 (核心通知)            │
│ ✓ 💰 支付通知 (核心通知)            │
│ [ ✓ ] 💬 站内消息                   │
│ [ ✗ ] 👍 点赞通知                   │
│ [ ✓ ] 💬 评论通知                   │
│ [ ✗ ] 👤 关注通知                   │
│ [ ✗ ] 💲 价格提醒                   │
│ ✓ 📢 系统公告 (核心通知)            │
│                                      │
│ [保存更改]                          │
└─────────────────────────────────────┘
```

---

## 🔌 后端API对接

### 已有API（NotificationPreferenceController）

```typescript
// 1. 开关通知渠道
POST /api/notifications/preferences/channel/{channel}/enabled/{enabled}
// 例如：POST /api/notifications/preferences/channel/EMAIL/enabled/true

// 2. 设置免打扰时段
POST /api/notifications/preferences/channel/{channel}/quiet-hours
Body: { startTime: "22:00", endTime: "08:00" }

// 3. 退订通知
POST /api/notifications/preferences/unsubscribe/{channel}/{templateCode}
// 例如：POST /api/notifications/preferences/unsubscribe/EMAIL/PRICE_ALERT

// 4. 重新订阅
DELETE /api/notifications/preferences/unsubscribe/{channel}/{templateCode}

// 5. 查询偏好状态
GET /api/notifications/preferences/status
```

---

## ✅ 验收标准

### 功能验收

- ✅ 可以开关每个通知渠道
- ✅ 可以设置免打扰时段
- ✅ 可以退订/重新订阅通知类型
- ✅ 设置保存后立即生效
- ✅ 页面刷新后设置保持

### 体验验收

- ✅ 界面简洁清晰
- ✅ 操作反馈及时（Toast提示）
- ✅ 核心通知（订单/支付）有明显标识
- ✅ 响应式设计（手机/平板/桌面）

### 性能验收

- ✅ 设置加载 < 1秒
- ✅ 保存响应 < 2秒

---

## 🚫 非功能性需求

### 安全性
- 🔒 用户只能修改自己的通知偏好
- 🔒 核心通知类型不可退订

### 可用性
- 📱 响应式设计
- ♿ 无障碍支持（键盘导航）
- 🌍 国际化支持（中英文）

### 性能
- ⚡ 设置加载 < 1秒
- ⚡ 保存响应 < 2秒

---

## 📝 边界与限制

### 包含范围
- ✅ 通知渠道开关
- ✅ 免打扰时段设置
- ✅ 通知类型订阅管理
- ✅ 偏好状态查询

### 不包含范围
- ❌ 通知历史记录（已有NotificationController）
- ❌ 通知模板管理（管理端功能）
- ❌ 通知发送统计

---

## 🔄 未来扩展

### Phase 2（可选）
- 📊 通知频率控制（每日最多N条）
- 📍 基于位置的通知偏好
- 🎯 通知内容过滤（关键词屏蔽）
- 📈 通知偏好推荐（AI分析）

---

## 🎯 成功指标

### 业务指标
- 📊 通知偏好设置使用率 > 30%
- 📊 用户投诉（通知骚扰）减少 > 50%
- 📊 通知打开率提升 > 20%

### 技术指标
- ⚡ 设置加载时间 < 1秒
- ✅ API成功率 > 99%
- 🐛 Bug率 < 1%

---

**需求确认**: ✅ 待评审  
**下一步**: 创建设计文档 (design.md)
