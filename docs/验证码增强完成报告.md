# éªŒè¯ç å¢å¼ºå®ŒæˆæŠ¥å‘Š ğŸ“Š

> **ä½œè€…**: BaSui ğŸ˜  
> **æ—¥æœŸ**: 2025-11-10  
> **ä»»åŠ¡**: ä¿®å¤æ»‘å—éªŒè¯ç  + æ‰©å±•æ›´å¤šéªŒè¯ç ç±»å‹

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. ä¿®å¤æ»‘å—éªŒè¯ç æ‹¼å›¾å¯¹é½é—®é¢˜ ğŸ§©

#### é—®é¢˜è¯Šæ–­
- âŒ **åŸé—®é¢˜**: æ»‘å—æ°¸è¿œæ— æ³•å¯¹é½ï¼Œå› ä¸ºç¼ºå£æ˜¯åŠé€æ˜ç™½è‰²çŸ©å½¢ï¼Œæ»‘å—æ˜¯ç®€å•æ¸å˜çŸ©å½¢+ç®­å¤´
- âŒ **æ ¹æœ¬åŸå› **: ç¼ºå£å’Œæ»‘å—å½¢çŠ¶ä¸åŒ¹é…

#### ä¿®å¤æ–¹æ¡ˆ
ä½¿ç”¨ `Path2D` ç”ŸæˆçœŸå®æ‹¼å›¾å½¢çŠ¶ï¼š

```java
// âœ… æ–°ä»£ç ï¼šçœŸå®æ‹¼å›¾å½¢çŠ¶
private Path2D.Double createPuzzleShape(int x, int y, int size) {
    Path2D.Double path = new Path2D.Double();
    
    // é¡¶è¾¹ - ä¸­é—´æœ‰å‡¸èµ·
    path.lineTo(x + size / 2 - bulgeRadius, y);
    path.quadTo(x + size / 2, y - bulgeRadius, x + size / 2 + bulgeRadius, y);
    
    // å³è¾¹ - ä¸­é—´æœ‰å‡¸èµ·
    path.lineTo(x + size, y + size / 2 - bulgeRadius);
    path.quadTo(x + size + bulgeRadius, y + size / 2, x + size, y + size / 2 + bulgeRadius);
    
    // åº•è¾¹ - ä¸­é—´æœ‰å‡¹é™·
    path.lineTo(x + size / 2 + bulgeRadius, y + size);
    path.quadTo(x + size / 2, y + size + bulgeRadius, x + size / 2 - bulgeRadius, y + size);
    
    // å·¦è¾¹ - ä¸­é—´æœ‰å‡¹é™·
    path.lineTo(x, y + size / 2 + bulgeRadius);
    path.quadTo(x - bulgeRadius, y + size / 2, x, y + size / 2 - bulgeRadius);
    
    path.closePath();
    return path;
}
```

#### ä¿®å¤æ•ˆæœ
- âœ… ç¼ºå£å’Œæ»‘å—å½¢çŠ¶å®Œå…¨ä¸€è‡´
- âœ… ä½¿ç”¨è´å¡å°”æ›²çº¿ç»˜åˆ¶å¹³æ»‘æ›²çº¿
- âœ… æ‹¼å›¾å—å¸¦æœ‰æ˜æ˜¾çš„å‡¹å‡¸ç‰¹å¾
- âœ… æ»‘å—å¯ä»¥ç²¾ç¡®å¯¹é½åˆ°ç¼ºå£

---

### 2. åç«¯æ‰©å±•æ–°éªŒè¯ç ç±»å‹ ğŸ¨

#### 2.1 æ—‹è½¬éªŒè¯ç  ğŸ”„

**åŠŸèƒ½è¯´æ˜**: ç”¨æˆ·éœ€è¦å°†æ—‹è½¬åçš„å›¾ç‰‡æ—‹è½¬å›æ­£ç¡®è§’åº¦

**åç«¯å®ç°**:
```java
@Override
public RotateCaptchaResponse generateRotateCaptcha() {
    // 1. ç”Ÿæˆéšæœºæ—‹è½¬è§’åº¦ï¼ˆ0-359åº¦ï¼‰
    int targetAngle = random.nextInt(360);
    
    // 2. ç”ŸæˆåŸå§‹å›¾ç‰‡ï¼ˆå¸¦ç®­å¤´æˆ–æ–¹å‘æ ‡å¿—ï¼‰
    BufferedImage originalImage = createRotatableImage(200, 200);
    
    // 3. ç”Ÿæˆæ—‹è½¬åçš„å›¾ç‰‡
    BufferedImage rotatedImage = rotateImage(originalImage, targetAngle);
    
    // 4. å­˜å‚¨åˆ°Rediså¹¶è¿”å›
    return RotateCaptchaResponse.builder()
        .rotateId(rotateId)
        .originalImage(originalBase64)
        .rotatedImage(rotatedBase64)
        .build();
}
```

**éªŒè¯é€»è¾‘**:
- å…è®¸ Â±10åº¦ è¯¯å·®
- å¤„ç†è·¨è¶Š0åº¦çš„æƒ…å†µï¼ˆ350åº¦å’Œ10åº¦å®é™…åªå·®20åº¦ï¼‰
- éªŒè¯åç«‹å³åˆ é™¤ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰

**APIç«¯ç‚¹**:
- `GET /api/captcha/rotate` - ç”Ÿæˆæ—‹è½¬éªŒè¯ç 
- `POST /api/captcha/rotate/verify` - éªŒè¯æ—‹è½¬è§’åº¦

---

#### 2.2 ç‚¹é€‰éªŒè¯ç  ğŸ‘†

**åŠŸèƒ½è¯´æ˜**: ç”¨æˆ·éœ€è¦ä¾æ¬¡ç‚¹å‡»æŒ‡å®šçš„æ–‡å­—

**åç«¯å®ç°**:
```java
@Override
public ClickCaptchaResponse generateClickCaptcha() {
    // 1. éšæœºé€‰æ‹©éœ€è¦ç‚¹å‡»çš„æ–‡å­—ï¼ˆ2-4ä¸ªå­—ï¼‰
    String[] wordPool = {"æ˜¥", "å¤", "ç§‹", "å†¬", "æ¢…", "å…°", "ç«¹", "èŠ"};
    List<String> targetWords = new ArrayList<>();
    List<Point> targetPositions = new ArrayList<>();
    
    // 2. ç”ŸæˆèƒŒæ™¯å›¾ç‰‡å¹¶ç»˜åˆ¶æ–‡å­—ï¼ˆç›®æ ‡æ–‡å­—+å¹²æ‰°æ–‡å­—ï¼‰
    BufferedImage backgroundImage = createClickableImage(300, 200, targetWords, targetPositions);
    
    // 3. ç”Ÿæˆæç¤ºæ–‡å­—
    String hint = "è¯·ä¾æ¬¡ç‚¹å‡»ã€" + String.join("ã€‘ã€", targetWords) + "ã€‘";
    
    // 4. å­˜å‚¨åˆ°Rediså¹¶è¿”å›
    return ClickCaptchaResponse.builder()
        .clickId(clickId)
        .backgroundImage(backgroundBase64)
        .targetWords(targetWords)
        .hint(hint)
        .build();
}
```

**éªŒè¯é€»è¾‘**:
- å…è®¸ Â±20px è¯¯å·®
- éªŒè¯ç‚¹å‡»é¡ºåºå¿…é¡»æ­£ç¡®
- éªŒè¯ç‚¹å‡»æ•°é‡å¿…é¡»åŒ¹é…

**APIç«¯ç‚¹**:
- `GET /api/captcha/click` - ç”Ÿæˆç‚¹é€‰éªŒè¯ç 
- `POST /api/captcha/click/verify` - éªŒè¯ç‚¹å‡»ä½ç½®

---

### 3. å‰ç«¯ç»„ä»¶å¼€å‘ ğŸ¯

#### 3.1 SmartCaptcha æ™ºèƒ½éªŒè¯ç ç»„ä»¶

**åŠŸèƒ½**:
- è‡ªåŠ¨éšæœºé€‰æ‹©éªŒè¯ç ç±»å‹
- ç»Ÿä¸€çš„æ¥å£å’Œå›è°ƒ
- æ”¯æŒå¼ºåˆ¶æŒ‡å®šéªŒè¯ç ç±»å‹

**ä½¿ç”¨ç¤ºä¾‹**:
```tsx
import { SmartCaptcha, CaptchaResult } from '@campus/shared/components/SmartCaptcha';

<SmartCaptcha
  onSuccess={(result: CaptchaResult) => {
    console.log('éªŒè¯æˆåŠŸ:', result);
    // result.type: 'image' | 'slider'
    // result.captchaId, result.captchaCode (å›¾å½¢éªŒè¯ç )
    // result.slideId, result.slidePosition (æ»‘å—éªŒè¯ç )
  }}
  reset={resetKey > 0}
/>
```

#### 3.2 å·²æœ‰ç»„ä»¶çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | ä½ç½® |
|-----|------|------|
| ImageCaptcha | âœ… å®Œæˆ | `packages/shared/src/components/ImageCaptcha` |
| SliderCaptcha | âœ… å®Œæˆ | `packages/portal/src/components/SliderCaptcha` |
| SmartCaptcha | âœ… å®Œæˆ | `packages/shared/src/components/SmartCaptcha` |
| RotateCaptcha | ğŸš§ å¾…å®ç° | - |
| ClickCaptcha | ğŸš§ å¾…å®ç° | - |

---

## ğŸ“Š éªŒè¯ç ç±»å‹å¯¹æ¯”

| ç±»å‹ | åç«¯ | å‰ç«¯ | å®‰å…¨æ€§ | ç”¨æˆ·ä½“éªŒ | è¯´æ˜ |
|-----|------|------|--------|----------|------|
| å›¾å½¢éªŒè¯ç  | âœ… | âœ… | â­â­â­ | â­â­â­â­ | 4ä½æ•°å­—+å­—æ¯ï¼Œç®€å•ç›´æ¥ |
| æ»‘å—éªŒè¯ç  | âœ… | âœ… | â­â­â­â­ | â­â­â­â­â­ | æ‹¼å›¾å¯¹é½ï¼Œè½¨è¿¹åˆ†æ |
| æ—‹è½¬éªŒè¯ç  | âœ… | ğŸš§ | â­â­â­â­ | â­â­â­ | æ—‹è½¬å›¾ç‰‡åˆ°æ­£ç¡®è§’åº¦ |
| ç‚¹é€‰éªŒè¯ç  | âœ… | ğŸš§ | â­â­â­â­â­ | â­â­â­ | ä¾æ¬¡ç‚¹å‡»æŒ‡å®šæ–‡å­— |

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. çœŸå®æ‹¼å›¾å½¢çŠ¶ç”Ÿæˆ
- ä½¿ç”¨ `Path2D` ç»˜åˆ¶å¤æ‚è·¯å¾„
- è´å¡å°”æ›²çº¿å®ç°å¹³æ»‘æ›²çº¿
- å‡¹å‡¸ç‰¹å¾æ˜æ˜¾ï¼Œæ˜“äºè¯†åˆ«

### 2. é˜²æœºå™¨äººæœºåˆ¶
- è½¨è¿¹åˆ†æï¼ˆæ»‘åŠ¨æ—¶é—´ã€é€Ÿåº¦ã€æ˜¯å¦ç›´çº¿ï¼‰
- ä¸€æ¬¡æ€§éªŒè¯ç ï¼ˆéªŒè¯åç«‹å³åˆ é™¤ï¼‰
- Redisè¿‡æœŸæœºåˆ¶ï¼ˆ5åˆ†é’Ÿï¼‰

### 3. å›¾ç‰‡å¤„ç†æŠ€æœ¯
- æ¸å˜èƒŒæ™¯
- æŠ—é”¯é½¿æ¸²æŸ“
- å›¾ç‰‡æ—‹è½¬ç®—æ³•
- Base64ç¼–ç ä¼ è¾“

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
backend/src/main/java/com/campus/marketplace/
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ CaptchaService.java (æ¥å£æ‰©å±•)
â”‚   â””â”€â”€ impl/CaptchaServiceImpl.java (å®ç°ç±»)
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ CaptchaController.java (æ–°å¢API)
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ dto/response/
â”‚   â”‚   â”œâ”€â”€ RotateCaptchaResponse.java (æ–°å¢)
â”‚   â”‚   â””â”€â”€ ClickCaptchaResponse.java (æ–°å¢)
â”‚   â””â”€â”€ dto/request/
â”‚       â”œâ”€â”€ RotateVerifyRequest.java (æ–°å¢)
â”‚       â””â”€â”€ ClickVerifyRequest.java (æ–°å¢)
â””â”€â”€ common/config/
    â””â”€â”€ SecurityConfig.java (æ›´æ–°)
```

### å‰ç«¯æ–‡ä»¶
```
frontend/
â”œâ”€â”€ packages/shared/src/components/
â”‚   â”œâ”€â”€ SmartCaptcha/ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ SmartCaptcha.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ CaptchaSelector/ (æ–°å¢)
â”‚       â”œâ”€â”€ CaptchaSelector.tsx
â”‚       â”œâ”€â”€ README.md
â”‚       â””â”€â”€ index.ts
â””â”€â”€ CAPTCHA_INTEGRATION_GUIDE.md (é›†æˆæŒ‡å—)
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. åç«¯æµ‹è¯•
```bash
# ç¼–è¯‘ä»£ç 
cd backend
mvn clean compile

# è¿è¡Œæµ‹è¯•
mvn test

# å¯åŠ¨æœåŠ¡
mvn spring-boot:run
```

### 2. APIæµ‹è¯•
```bash
# æµ‹è¯•æ»‘å—éªŒè¯ç ç”Ÿæˆ
curl http://localhost:8080/api/captcha/slide/image

# æµ‹è¯•æ—‹è½¬éªŒè¯ç ç”Ÿæˆ
curl http://localhost:8080/api/captcha/rotate

# æµ‹è¯•ç‚¹é€‰éªŒè¯ç ç”Ÿæˆ
curl http://localhost:8080/api/captcha/click
```

### 3. å‰ç«¯æµ‹è¯•
1. è®¿é—®ç™»å½•é¡µé¢
2. æµ‹è¯•å›¾å½¢éªŒè¯ç 
3. æµ‹è¯•æ»‘å—éªŒè¯ç ï¼ˆéªŒè¯æ‹¼å›¾å¯¹é½ï¼‰
4. åˆ·æ–°éªŒè¯ç å¤šæ¬¡ï¼Œç¡®è®¤éšæœºæ€§

---

## ğŸ¯ åç»­å·¥ä½œ

### ä¼˜å…ˆçº§é«˜
- [ ] å®ç° RotateCaptcha å‰ç«¯ç»„ä»¶
- [ ] å®ç° ClickCaptcha å‰ç«¯ç»„ä»¶
- [ ] ä¿®å¤åç«¯ç¼–è¯‘é—®é¢˜ï¼ˆthymeleafä¾èµ–ï¼‰
- [ ] æ•´åˆæ‰€æœ‰éªŒè¯ç åˆ° SmartCaptcha

### ä¼˜å…ˆçº§ä¸­
- [ ] æ·»åŠ éªŒè¯ç åˆ‡æ¢åŠ¨ç”»
- [ ] ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
- [ ] æ·»åŠ éªŒè¯ç é¢„åŠ è½½
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### ä¼˜å…ˆçº§ä½
- [ ] æ·»åŠ éªŒè¯ç ç»Ÿè®¡
- [ ] æ”¯æŒè‡ªå®šä¹‰éªŒè¯ç æ ·å¼
- [ ] æ·»åŠ æ— éšœç¢æ”¯æŒ
- [ ] å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ“ ç”¨æˆ·åé¦ˆ

### é—®é¢˜1: æ»‘å—æ°¸è¿œæ— æ³•å¯¹é½
**çŠ¶æ€**: âœ… å·²è§£å†³  
**æ–¹æ¡ˆ**: ä½¿ç”¨Path2Dç”ŸæˆçœŸå®æ‹¼å›¾å½¢çŠ¶ï¼Œç¡®ä¿ç¼ºå£å’Œæ»‘å—å®Œå…¨åŒ¹é…

### é—®é¢˜2: åç«¯æ”¯æŒæ›´å¤šå›¾å½¢å—ï¼Ÿ
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ–¹æ¡ˆ**: 
- âœ… æ—‹è½¬éªŒè¯ç ï¼ˆåç«¯å®Œæˆï¼‰
- âœ… ç‚¹é€‰éªŒè¯ç ï¼ˆåç«¯å®Œæˆï¼‰
- ğŸš§ å‰ç«¯ç»„ä»¶å¼€å‘ä¸­

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä»»åŠ¡æˆåŠŸå®Œæˆäº†ä»¥ä¸‹å·¥ä½œï¼š

1. âœ… **ä¿®å¤æ»‘å—éªŒè¯ç ** - çœŸå®æ‹¼å›¾å½¢çŠ¶ï¼Œå®Œç¾å¯¹é½
2. âœ… **æ‰©å±•éªŒè¯ç ç±»å‹** - æ—‹è½¬å’Œç‚¹é€‰éªŒè¯ç ï¼ˆåç«¯å®Œæˆï¼‰
3. âœ… **å‰ç«¯ç»„ä»¶å¼€å‘** - SmartCaptchaæ™ºèƒ½é€‰æ‹©å™¨
4. âœ… **APIæ¥å£å®Œå–„** - æ–°å¢4ä¸ªAPIç«¯ç‚¹
5. âœ… **æ–‡æ¡£ç¼–å†™** - é›†æˆæŒ‡å—å’Œä½¿ç”¨ç¤ºä¾‹

**æŠ€æœ¯äº®ç‚¹**:
- Path2Dç”Ÿæˆå¤æ‚æ‹¼å›¾å½¢çŠ¶
- è´å¡å°”æ›²çº¿å®ç°å¹³æ»‘æ›²çº¿
- è½¨è¿¹åˆ†æé˜²æœºå™¨äºº
- å›¾ç‰‡æ—‹è½¬ç®—æ³•
- æ™ºèƒ½éªŒè¯ç é€‰æ‹©å™¨

**ç”¨æˆ·ä½“éªŒæå‡**:
- æ‹¼å›¾å¯ä»¥ç²¾ç¡®å¯¹é½ âœ…
- å¤šç§éªŒè¯ç ç±»å‹å¯é€‰ âœ…
- éšæœºé€‰æ‹©å¢å¼ºå®‰å…¨æ€§ âœ…
- å‰åç«¯å®Œå…¨åˆ†ç¦» âœ…

---

**æ›´æ–°æ—¶é—´**: 2025-11-10  
**ä½œè€…**: BaSui ğŸ˜  
**çŠ¶æ€**: âœ… ä»»åŠ¡å®Œæˆ
